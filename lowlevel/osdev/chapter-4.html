<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="OSDev Chapter 4 Memory Management" /><meta name="author" content="Zeropio" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://zeropio.ninja//lowlevel/osdev/chapter-4" /><meta property="og:url" content="https://zeropio.ninja//lowlevel/osdev/chapter-4" /><meta property="og:site_name" content="Zeropio’s Dojo" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-27T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="OSDev Chapter 4 Memory Management" /><meta name="twitter:site" content="@ZeropioWasTaken" /><meta name="twitter:creator" content="@ZeropioWasTaken" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zeropio","url":"https://twitter.com/ZeropioWasTaken"},"dateModified":"2023-05-09T11:14:07+02:00","datePublished":"2023-04-27T00:00:00+02:00","description":"Introduction","headline":"OSDev Chapter 4 Memory Management","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeropio.ninja//lowlevel/osdev/chapter-4"},"url":"https://zeropio.ninja//lowlevel/osdev/chapter-4"}</script><title>OSDev | Chapter 4 | Memory Management | Zeropio's Dojo</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Zeropio's Dojo"><meta name="application-name" content="Zeropio's Dojo"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/icon.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Zeropio's Dojo</a></div><div class="site-subtitle font-italic">Cyberninja</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zeropio" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://ctftime.org/team/212175" aria-label="ctftime" target="_blank" rel="noopener noreferrer"> <i class="fas fa-flag"></i> </a> <a href="https://app.hackthebox.com/profile/380109" aria-label="hackthebox" target="_blank" rel="noopener noreferrer"> <i class="fas fa-cube"></i> </a> <a href="https://twitter.com/ZeropioWasTaken" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>OSDev | Chapter 4 | Memory Management</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>OSDev | Chapter 4 | Memory Management</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1682546400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 27, 2023 </em> </span> <span> Updated <em class="" data-ts="1683623647" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 9, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/ZeropioWasTaken">Zeropio</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2526 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In this part, we will implement two key memory management features: paging, which enables mapping physical memory to virtual memory, and heap allocation, which provides dynamic memory allocation for processes.</p><p><br /></p><hr /><h2 id="paging"><span class="mr-2">Paging</span><a href="#paging" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Memory access for each program should be independent from others. One process should not be able to access the memory of another process. <strong>Segmentation</strong> and <strong>paging</strong> allow us to achieve this.</p><p>Segmentation creates <em>virtual memory</em>, where a piece of memory is reserved and isolated for a process. Each block of memory for each process of virtual memory is allocated on the physical memory, plus an offset. This makes each process have a different space of the memory. However, segmentation is not typically used in modern systems due to fragmentation. If we want to add new virtual memory for a new process, but there is not a whole chunk we can use, the previous chunks are reallocated in the physical memory. This makes the CPU stop processes at random times, move big blocks of data, and lower the performance.</p><p><a href="/assets/img/osdev/Segmentation-1.png" class="popup img-link "><img data-src="/assets/img/osdev/Segmentation-1.png" alt="" class="lazyload" data-proofer-ignore></a> <em>First Step Fragmentation</em></p><p><br /></p><p><a href="/assets/img/osdev/Segmentation-2.png" class="popup img-link "><img data-src="/assets/img/osdev/Segmentation-2.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Second Step Fragmentation</em></p><p>With paging, instead of creating big chunks of addresses for a process, we split the virtual memory into small chunks and reallocate it without problems:</p><p><a href="/assets/img/osdev/Pagination-1.png" class="popup img-link "><img data-src="/assets/img/osdev/Pagination-1.png" alt="" class="lazyload" data-proofer-ignore></a> <em>First Step Pagination</em></p><p><br /></p><p><a href="/assets/img/osdev/Pagination-2.png" class="popup img-link "><img data-src="/assets/img/osdev/Pagination-2.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Second Step Pagination</em></p><p>As we can see, paging uses a lot of small blocks instead of one big block. There is still some fragmentation (called <em>internal fragmentation</em>). This internal fragmentation is not fixed; some blocks can have different sizes between them. Because of the <em>chaotic</em> appearance, paging has <strong>Page Tables</strong> where each process has its own, mapping all the sections. This table is stored as a pointer to it on the CR3 register. All this work is done at the hardware level.</p><p>For size optimization, some page tables can leave empty chunks. Because of this, instead of having one page table, we have one main page table that links to one page table for each group of segmentations. On x86_64, we have a 4-level page table. Each page table has a fixed size of <strong>512 entries</strong>. Each entry has a size of 8 bytes.</p><p>In Rust, we can create a page table as follows:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">#[repr(align(</span><span class="mi">4096</span><span class="nd">))]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">PageTable</span> <span class="p">{</span>
    <span class="n">entries</span><span class="p">:</span> <span class="p">[</span><span class="n">PageTableEntry</span><span class="p">;</span> <span class="mi">512</span><span class="p">],</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As each entry is 8 bytes large, we have the following format:</p><div class="table-wrapper"><table><thead><tr><th><strong>Bit</strong><th><strong>Name</strong><th><strong>Description</strong><tbody><tr><td>0<td>present<td>the page is in memory<tr><td>1<td>writable<td>allowed to write<tr><td>2<td>user accessible<td>if not set, only kernel mode can access<tr><td>3<td>write-through caching<td>writes go to memory<tr><td>4<td>disable cache<td>no cache<tr><td>5<td>accessed<td>sets if this page is used<tr><td>6<td>dirty<td>set when a write occurs<tr><td>7<td>huge page/null<td>must be 0 in P1 and P4, creates a 1 GiB page in P3, creates a 2 MiB page in P2<tr><td>8<td>global<td>page isn’t flushed from caches on address space switch<tr><td>9 - 11<td>available<td>can be used freely by the OS<tr><td>12 - 51<td>physical address<td>the page aligned 52-bit physical address of the frame or the next page table<tr><td>52 - 62<td>available<td>can be used freely by the OS<tr><td>63<td>no execute<td>forbids executing code on this page (NXE)</table></div><p>The kernel we have written already works on 4-level paging due to being in 64-bit mode.</p><p><br /></p><hr /><h2 id="implementation"><span class="mr-2">Implementation</span><a href="#implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="page-fault"><span class="mr-2">Page Fault</span><a href="#page-fault" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can create a <strong>page fault</strong> by accessing a non-existent region. First, edit <code class="language-plaintext filepath highlighter-rouge">src/interrupts.rs</code>:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nd">lazy_static!</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">ref</span> <span class="n">IDT</span><span class="p">:</span> <span class="n">InterruptDescriptorTable</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">idt</span> <span class="o">=</span> <span class="nn">InterruptDescriptorTable</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="o">...</span>
        <span class="n">idt</span><span class="py">.page_fault</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">page_fault_handler</span><span class="p">);</span>
        <span class="n">idt</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">structures</span><span class="p">::</span><span class="nn">idt</span><span class="p">::</span><span class="n">PageFaultErrorCode</span><span class="p">;</span>
<span class="k">use</span> <span class="k">crate</span><span class="p">::</span><span class="n">hlt_loop</span><span class="p">;</span>

<span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">page_fault_handler</span><span class="p">(</span><span class="n">stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">,</span> <span class="n">error_code</span><span class="p">:</span> <span class="n">PageFaultErrorCode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">registers</span><span class="p">::</span><span class="nn">control</span><span class="p">::</span><span class="n">Cr2</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"EXCEPTION: PAGE FAULT"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Accessed Address: {:?}"</span><span class="p">,</span> <span class="nn">Cr2</span><span class="p">::</span><span class="nf">read</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Error Code: {:?}"</span><span class="p">,</span> <span class="n">error_code</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:#?}"</span><span class="p">,</span> <span class="n">stack_frame</span><span class="p">);</span>
    <span class="nf">hlt_loop</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And now, access memory from outside the kernel:</p><div file="src/main.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/main.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="n">ptr</span> <span class="o">=</span> <span class="mi">0xdeadbeaf</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u32</span><span class="p">;</span>
<span class="k">unsafe</span> <span class="p">{</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span> <span class="p">}</span>
</pre></table></code></div></div><p>The problem with the page tables is that they are stored in physical memory, and the kernel can only access virtual memory. To access the page tables, we need the bootloader. We can take different approaches to it, like:</p><ul><li><strong>Identity Mapping</strong>: cloning the physical memory to the virtual memory to have an exact copy of the page tables. But here we have the problem of segmentation.<li><strong>Map a Fixed Offset</strong>: to avoid cluttering, we can use a separate memory region for page table mappings.<li><strong>Mapping Physical Memory</strong>: instead of just mapping the page table, we can map the entire physical memory.<li><strong>Temporary Mapping</strong>: we can map the page table frames only when we need it.<li><strong>Recursive Page Tables</strong>: instead of creating new tables, we can map the level 4 page table to the level 4 table itself.</ul><h3 id="return-to-the-bootloader"><span class="mr-2">Return to the Bootloader</span><a href="#return-to-the-bootloader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We will need to use the previously used <strong>bootloader</strong> crate, with the <code class="language-plaintext highlighter-rouge">map_physical_memory</code> feature:</p><div file="Cargo.toml" class="language-toml highlighter-rouge"><div class="code-header"> <span data-label-text="Cargo.toml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nn">[dependencies]</span>
<span class="nn">bootloader</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.9.23"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="p">[</span><span class="s">"map_physical_memory"</span><span class="p">]}</span>
</pre></table></code></div></div><p>Now, the bootloader maps the complete physical memory to some virtual address range and passes a <em>boot information</em> structure to the kernel. This crate includes a <code class="language-plaintext highlighter-rouge">BootInfo</code> struct. Currently, it contains two values: <code class="language-plaintext highlighter-rouge">memory_map</code> (an overview of the available physical memory) and <code class="language-plaintext highlighter-rouge">physical_memory_offset</code> (the virtual start address of the physical memory mapping).</p><p>Now we need to set it on <code class="language-plaintext filepath highlighter-rouge">src/main.rs</code>. The crate provides the <code class="language-plaintext highlighter-rouge">entry_point</code> macro that sets everything for us. We don’t need to create our own <code class="language-plaintext highlighter-rouge">_start</code>, since <code class="language-plaintext highlighter-rouge">entry_point</code> will be doing it. We need to import the crate, set the entry point, replace the <code class="language-plaintext highlighter-rouge">_start</code> function with a new <code class="language-plaintext highlighter-rouge">kernel_main</code>, and we don’t need to specify <code class="language-plaintext highlighter-rouge">no_mangle</code> anymore:</p><div file="src/main.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/main.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bootloader</span><span class="p">::{</span><span class="n">BootInfo</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">};</span>

<span class="nd">entry_point!</span><span class="p">(</span><span class="n">kernel_main</span><span class="p">);</span>

<span class="k">fn</span> <span class="nf">kernel_main</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="n">BootInfo</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="p">[</span><span class="err">…</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="page-tables"><span class="mr-2">Page Tables</span><a href="#page-tables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now we can implement the page tables. Import a new module and create a new <code class="language-plaintext filepath highlighter-rouge">src/memory.rs</code>:</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">mod</span> <span class="n">memory</span><span class="p">;</span>
</pre></table></code></div></div><p>We are going to create a reader for the level 4 page table. First, read the physical frame of the level 4 table from the CR3 register. Add the physical start address to <code class="language-plaintext highlighter-rouge">physical_memory_offset</code> to get the virtual address and create an unsafe pointer to it:</p><div file="src/memory.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/memory.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">x86_64</span><span class="p">::{</span>
    <span class="nn">structures</span><span class="p">::</span><span class="nn">paging</span><span class="p">::</span><span class="n">PageTable</span><span class="p">,</span>
    <span class="n">VirtAddr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">pub</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">active_level_4_table</span><span class="p">(</span><span class="n">physical_memory_offset</span><span class="p">:</span> <span class="n">VirtAddr</span><span class="p">)</span>
    <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="k">mut</span> <span class="n">PageTable</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">registers</span><span class="p">::</span><span class="nn">control</span><span class="p">::</span><span class="n">Cr3</span><span class="p">;</span>

    <span class="k">let</span> <span class="p">(</span><span class="n">level_4_table_frame</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Cr3</span><span class="p">::</span><span class="nf">read</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">phys</span> <span class="o">=</span> <span class="n">level_4_table_frame</span><span class="nf">.start_address</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">virt</span> <span class="o">=</span> <span class="n">physical_memory_offset</span> <span class="o">+</span> <span class="n">phys</span><span class="nf">.as_u64</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">page_table_ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="n">PageTable</span> <span class="o">=</span> <span class="n">virt</span><span class="nf">.as_mut_ptr</span><span class="p">();</span>

    <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="n">page_table_ptr</span> <span class="c1">// unsafe</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Using this reader, we can print the entries of the level 4 table.</p><div file="src/main.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/main.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">kernel_main</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="n">BootInfo</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">zeros</span><span class="p">::</span><span class="nn">memory</span><span class="p">::</span><span class="n">active_level_4_table</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="n">VirtAddr</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Hello World{}"</span><span class="p">,</span> <span class="s">"!"</span><span class="p">);</span>
    <span class="nn">blog_os</span><span class="p">::</span><span class="nf">init</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">phys_mem_offset</span> <span class="o">=</span> <span class="nn">VirtAddr</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">boot_info</span><span class="py">.physical_memory_offset</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">l4_table</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nf">active_level_4_table</span><span class="p">(</span><span class="n">phys_mem_offset</span><span class="p">)</span> <span class="p">};</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="k">in</span> <span class="n">l4_table</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">entry</span><span class="nf">.is_unused</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"L4 Entry {}: {:?}"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We can now see the contents:</p><p><a href="/assets/img/osdev/2023-04-27_18-34.png" class="popup img-link "><img data-src="/assets/img/osdev/2023-04-27_18-34.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Level 4 Table</em></p><p>Let’s take a closer look at the lower levels of the page tables:</p><div file="src/main.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/main.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="k">in</span> <span class="n">l4_table</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">structures</span><span class="p">::</span><span class="nn">paging</span><span class="p">::</span><span class="n">PageTable</span><span class="p">;</span>

        <span class="k">if</span> <span class="o">!</span><span class="n">entry</span><span class="nf">.is_unused</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"L4 Entry {}: {:?}"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

            <span class="k">let</span> <span class="n">phys</span> <span class="o">=</span> <span class="n">entry</span><span class="nf">.frame</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.start_address</span><span class="p">();</span>
            <span class="k">let</span> <span class="n">virt</span> <span class="o">=</span> <span class="n">phys</span><span class="nf">.as_u64</span><span class="p">()</span> <span class="o">+</span> <span class="n">boot_info</span><span class="py">.physical_memory_offset</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">ptr</span> <span class="o">=</span> <span class="nn">VirtAddr</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">virt</span><span class="p">)</span><span class="nf">.as_mut_ptr</span><span class="p">();</span>
            <span class="k">let</span> <span class="n">l3_table</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PageTable</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span><span class="n">ptr</span> <span class="p">};</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="k">in</span> <span class="n">l3_table</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="o">!</span><span class="n">entry</span><span class="nf">.is_unused</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nd">println!</span><span class="p">(</span><span class="s">"  L3 Entry {}: {:?}"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><h3 id="translating"><span class="mr-2">Translating</span><a href="#translating" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can create a function to translate physical addresses to virtual memory addresses with the <code class="language-plaintext highlighter-rouge">x86_64</code> crate’s <code class="language-plaintext highlighter-rouge">OffsetPageTable</code> function:</p><div file="src/memory.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/memory.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">structures</span><span class="p">::</span><span class="nn">paging</span><span class="p">::</span><span class="n">OffsetPageTable</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="n">physical_memory_offset</span><span class="p">:</span> <span class="n">VirtAddr</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">OffsetPageTable</span><span class="o">&lt;</span><span class="k">'static</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">level_4_table</span> <span class="o">=</span> <span class="nf">active_level_4_table</span><span class="p">(</span><span class="n">physical_memory_offset</span><span class="p">);</span>
    <span class="nn">OffsetPageTable</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">level_4_table</span><span class="p">,</span> <span class="n">physical_memory_offset</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="new-mapping"><span class="mr-2">New Mapping</span><a href="#new-mapping" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Instead of reading page tables, we are going to create new mappings. First, we need to create a frame allocator. We can do it with the <code class="language-plaintext highlighter-rouge">bootloader</code> crate. We made an iterator of usable frames before:</p><div file="src/memory.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/memory.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">x86_64</span><span class="p">::{</span>
    <span class="nn">structures</span><span class="p">::</span><span class="nn">paging</span><span class="p">::{</span><span class="n">PageTable</span><span class="p">,</span> <span class="n">OffsetPageTable</span><span class="p">,</span> <span class="n">PhysFrame</span><span class="p">,</span> <span class="n">Size4KiB</span><span class="p">,</span> <span class="n">FrameAllocator</span><span class="p">},</span>
    <span class="n">VirtAddr</span><span class="p">,</span>
    <span class="n">PhysAddr</span>
<span class="p">};</span>
<span class="k">use</span> <span class="nn">bootloader</span><span class="p">::</span><span class="nn">bootinfo</span><span class="p">::{</span><span class="n">MemoryMap</span><span class="p">,</span> <span class="n">MemoryRegionType</span><span class="p">};</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">BootInfoFrameAllocator</span> <span class="p">{</span>
    <span class="n">memory_map</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="n">MemoryMap</span><span class="p">,</span>
    <span class="n">next</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">BootInfoFrameAllocator</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="n">memory_map</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="n">MemoryMap</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">BootInfoFrameAllocator</span> <span class="p">{</span>
            <span class="n">memory_map</span><span class="p">,</span>
            <span class="n">next</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">BootInfoFrameAllocator</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">usable_frames</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">impl</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span> <span class="o">=</span> <span class="n">PhysFrame</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">regions</span> <span class="o">=</span> <span class="k">self</span><span class="py">.memory_map</span><span class="nf">.iter</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">usable_regions</span> <span class="o">=</span> <span class="n">regions</span>
            <span class="nf">.filter</span><span class="p">(|</span><span class="n">r</span><span class="p">|</span> <span class="n">r</span><span class="py">.region_type</span> <span class="o">==</span> <span class="nn">MemoryRegionType</span><span class="p">::</span><span class="n">Usable</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">addr_ranges</span> <span class="o">=</span> <span class="n">usable_regions</span>
            <span class="nf">.map</span><span class="p">(|</span><span class="n">r</span><span class="p">|</span> <span class="n">r</span><span class="py">.range</span><span class="nf">.start_addr</span><span class="p">()</span><span class="o">..</span><span class="n">r</span><span class="py">.range</span><span class="nf">.end_addr</span><span class="p">());</span>
        <span class="k">let</span> <span class="n">frame_addresses</span> <span class="o">=</span> <span class="n">addr_ranges</span><span class="nf">.flat_map</span><span class="p">(|</span><span class="n">r</span><span class="p">|</span> <span class="n">r</span><span class="nf">.step_by</span><span class="p">(</span><span class="mi">4096</span><span class="p">));</span>
        <span class="n">frame_addresses</span><span class="nf">.map</span><span class="p">(|</span><span class="n">addr</span><span class="p">|</span> <span class="nn">PhysFrame</span><span class="p">::</span><span class="nf">containing_address</span><span class="p">(</span><span class="nn">PhysAddr</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The function:</p><ol><li>Converts the memory map to an iterator of <code class="language-plaintext highlighter-rouge">MemoryRegion</code><li>Uses <code class="language-plaintext highlighter-rouge">filter</code> to remove unavailable regions<li>Uses <code class="language-plaintext highlighter-rouge">map</code> to transform our iterator of memory regions to an iterator of address ranges<li>Uses <code class="language-plaintext highlighter-rouge">flat_map</code> to transform the address ranges into an iterator of frame start addresses<li>Converts the start address to <code class="language-plaintext highlighter-rouge">PhysFrame</code></ol><p>Next, we will implement the <code class="language-plaintext highlighter-rouge">FrameAllocator</code> trait:</p><div file="src/memory.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/memory.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">unsafe</span> <span class="k">impl</span> <span class="n">FrameAllocator</span><span class="o">&lt;</span><span class="n">Size4KiB</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">BootInfoFrameAllocator</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">allocate_frame</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">PhysFrame</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">frame</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.usable_frames</span><span class="p">()</span><span class="nf">.nth</span><span class="p">(</span><span class="k">self</span><span class="py">.next</span><span class="p">);</span>
        <span class="k">self</span><span class="py">.next</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">frame</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><br /></p><hr /><h2 id="heap-allocation"><span class="mr-2">Heap Allocation</span><a href="#heap-allocation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There are two types of variables: <strong>local</strong> variables and <strong>static</strong> variables. Local variables are stored on the <em>call stack</em><sup id="fnref:footnote" role="doc-noteref"><a href="#fn:footnote" class="footnote" rel="footnote">1</a></sup> and are only valid until the surrounding function returns.</p><p>Static variables (<code class="language-plaintext highlighter-rouge">'static</code>) are stored at a fixed memory location separate from the stack. This memory is assigned at compile time by the linker. Statics live for the complete runtime of the program and are by default read-only to prevent data races. To modify a static variable, we need to encapsulate it in a <code class="language-plaintext highlighter-rouge">Mutex</code> type.</p><p>Both local and static variables have a fixed size. Because of this downside, programming languages usually provide a third option called the <strong>heap</strong>. The heap is a dynamic memory allocation at runtime with two functions: <code class="language-plaintext highlighter-rouge">allocate</code> and <code class="language-plaintext highlighter-rouge">deallocate</code>. The <code class="language-plaintext highlighter-rouge">allocate</code> function returns a free chunk of memory, while <code class="language-plaintext highlighter-rouge">deallocate</code> frees the chunk. This chunk is valid until <code class="language-plaintext highlighter-rouge">deallocate</code> is called. The advantage of using heap memory compared to static memory is that the memory can be reused after it is freed. However, this can also lead to new errors such as <em>memory leaks</em>, <em>use-after-free</em>, <em>double-free</em>, etc. This is where <strong>garbage collection</strong> or <strong>ownership</strong> in Rust takes action.</p><p>Using the heap in the kernel is necessary when we need to start using structs like <code class="language-plaintext highlighter-rouge">Vec</code> or <code class="language-plaintext highlighter-rouge">String</code> that grow in size.</p><h3 id="the-allocator"><span class="mr-2">The Allocator</span><a href="#the-allocator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First, we need to create the heap allocator with the built-in <code class="language-plaintext highlighter-rouge">alloc</code> crate. To add it to the default compiler:</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="k">crate</span> <span class="n">alloc</span><span class="p">;</span>
</pre></table></code></div></div><p>And add it to the default compiler:</p><div file=".cargo/config.toml" class="language-toml highlighter-rouge"><div class="code-header"> <span data-label-text=".cargo/config.toml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nn">[unstable]</span>
<span class="py">build-std</span> <span class="p">=</span> <span class="p">[</span><span class="s">"core"</span><span class="p">,</span> <span class="s">"compiler_builtins"</span><span class="p">,</span> <span class="s">"alloc"</span><span class="p">]</span>
</pre></table></code></div></div><p>This will provoke some errors because <code class="language-plaintext highlighter-rouge">alloc</code> depends on the <code class="language-plaintext highlighter-rouge">GlobalAlloc</code> trait, which implements <code class="language-plaintext highlighter-rouge">alloc</code> and <code class="language-plaintext highlighter-rouge">dealloc</code>, as well as <code class="language-plaintext highlighter-rouge">alloc_zeroed</code> (allocated and set to zero) and <code class="language-plaintext highlighter-rouge">realloc</code> (resize chunks). Now we need to recreate these functions in our program in a new file: <code class="language-plaintext filepath highlighter-rouge">src/allocator.rs</code>:</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">mod</span> <span class="n">allocator</span><span class="p">;</span>
</pre></table></code></div></div><div file="src/allocator.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/allocator.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">alloc</span><span class="p">::</span><span class="nn">alloc</span><span class="p">::{</span><span class="n">GlobalAlloc</span><span class="p">,</span> <span class="n">Layout</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">core</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="n">null_mut</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">Dummy</span><span class="p">;</span>

<span class="k">unsafe</span> <span class="k">impl</span> <span class="n">GlobalAlloc</span> <span class="k">for</span> <span class="n">Dummy</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span> <span class="p">{</span>
        <span class="nf">null_mut</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">dealloc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">_ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">panic!</span><span class="p">(</span><span class="s">"dealloc should be never called"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Next, we must define the <code class="language-plaintext highlighter-rouge">#[global_allocator]</code> and <code class="language-plaintext highlighter-rouge">#[alloc_error_handler]</code> attributes:</p><div file="src/allocator.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/allocator.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nd">#[global_allocator]</span>
<span class="k">static</span> <span class="n">ALLOCATOR</span><span class="p">:</span> <span class="n">Dummy</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">;</span>
</pre></table></code></div></div><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">#![feature(alloc_error_handler)]</span> <span class="c1">// at the top of the file</span>

<span class="nd">#[alloc_error_handler]</span>
<span class="k">fn</span> <span class="nf">alloc_error_handler</span><span class="p">(</span><span class="n">layout</span><span class="p">:</span> <span class="nn">alloc</span><span class="p">::</span><span class="nn">alloc</span><span class="p">::</span><span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="nd">panic!</span><span class="p">(</span><span class="s">"allocation error: {:?}"</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="the-kernel-heap"><span class="mr-2">The Kernel Heap</span><a href="#the-kernel-heap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before creating an allocator, we need to reserve a space in memory for the heap. We can use the previous functions we created for memory mapping to do this. Let’s give it a starting address:</p><div file="src/allocator.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/allocator.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">const</span> <span class="n">HEAP_START</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">0x_4444_4444_0000</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">const</span> <span class="n">HEAP_SIZE</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span> <span class="c1">// 100 KiB</span>
</pre></table></code></div></div><p>Now we need to map it to physical memory:</p><div file="src/allocator.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/allocator.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">x86_64</span><span class="p">::{</span>
    <span class="nn">structures</span><span class="p">::</span><span class="nn">paging</span><span class="p">::{</span>
        <span class="nn">mapper</span><span class="p">::</span><span class="n">MapToError</span><span class="p">,</span> <span class="n">FrameAllocator</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">,</span> <span class="n">Page</span><span class="p">,</span> <span class="n">PageTableFlags</span><span class="p">,</span> <span class="n">Size4KiB</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">VirtAddr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">init_heap</span><span class="p">(</span>
    <span class="n">mapper</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">impl</span> <span class="n">Mapper</span><span class="o">&lt;</span><span class="n">Size4KiB</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">frame_allocator</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">impl</span> <span class="n">FrameAllocator</span><span class="o">&lt;</span><span class="n">Size4KiB</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">MapToError</span><span class="o">&lt;</span><span class="n">Size4KiB</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">page_range</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">heap_start</span> <span class="o">=</span> <span class="nn">VirtAddr</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">HEAP_START</span> <span class="k">as</span> <span class="nb">u64</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">heap_end</span> <span class="o">=</span> <span class="n">heap_start</span> <span class="o">+</span> <span class="n">HEAP_SIZE</span> <span class="o">-</span> <span class="mi">1u64</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">heap_start_page</span> <span class="o">=</span> <span class="nn">Page</span><span class="p">::</span><span class="nf">containing_address</span><span class="p">(</span><span class="n">heap_start</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">heap_end_page</span> <span class="o">=</span> <span class="nn">Page</span><span class="p">::</span><span class="nf">containing_address</span><span class="p">(</span><span class="n">heap_end</span><span class="p">);</span>
        <span class="nn">Page</span><span class="p">::</span><span class="nf">range_inclusive</span><span class="p">(</span><span class="n">heap_start_page</span><span class="p">,</span> <span class="n">heap_end_page</span><span class="p">)</span>
    <span class="p">};</span>

    <span class="k">for</span> <span class="n">page</span> <span class="k">in</span> <span class="n">page_range</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_allocator</span>
            <span class="nf">.allocate_frame</span><span class="p">()</span>
            <span class="nf">.ok_or</span><span class="p">(</span><span class="nn">MapToError</span><span class="p">::</span><span class="n">FrameAllocationFailed</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">flags</span> <span class="o">=</span> <span class="nn">PageTableFlags</span><span class="p">::</span><span class="n">PRESENT</span> <span class="p">|</span> <span class="nn">PageTableFlags</span><span class="p">::</span><span class="n">WRITABLE</span><span class="p">;</span>
        <span class="k">unsafe</span> <span class="p">{</span>
            <span class="n">mapper</span><span class="nf">.map_to</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">frame_allocator</span><span class="p">)</span><span class="o">?</span><span class="nf">.flush</span><span class="p">()</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Here’s what’s happening:</p><ul><li><strong>Creating the page range</strong>: we convert <code class="language-plaintext highlighter-rouge">HEAP_START</code> to a <code class="language-plaintext highlighter-rouge">VirtAddr</code> type, calculate the heap address, convert the addresses to <code class="language-plaintext highlighter-rouge">Page</code> type and create a page range from the start to end.<li><strong>Mapping the pages</strong>: now we map all pages of the page range. We iterate over them and:<ul><li>Allocate a physical frame for the page that should be mapped.<li>Set the <code class="language-plaintext highlighter-rouge">PRESENT</code> and <code class="language-plaintext highlighter-rouge">WRITABLE</code> flags.<li>Create the mapping in the active page table.</ul></ul><p>Finally, we need to call the function in <code class="language-plaintext highlighter-rouge">kernel_main</code>:</p><div file="src/main.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/main.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>    <span class="k">use</span> <span class="nn">zeros</span><span class="p">::</span><span class="n">allocator</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">zeros</span><span class="p">::</span><span class="nn">memory</span><span class="p">::{</span><span class="k">self</span><span class="p">,</span> <span class="n">BootInfoFrameAllocator</span><span class="p">};</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="n">VirtAddr</span><span class="p">;</span>

    <span class="nn">zeros</span><span class="p">::</span><span class="nf">init</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">phys_mem_offset</span> <span class="o">=</span> <span class="nn">VirtAddr</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">boot_info</span><span class="py">.physical_memory_offset</span><span class="p">);</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">memory</span><span class="p">::</span><span class="nf">init</span><span class="p">(</span><span class="n">phys_mem_offset</span><span class="p">)</span> <span class="p">};</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">frame_allocator</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span>
        <span class="nn">BootInfoFrameAllocator</span><span class="p">::</span><span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_info</span><span class="py">.memory_map</span><span class="p">)</span>
    <span class="p">};</span>

    <span class="nn">allocator</span><span class="p">::</span><span class="nf">init_heap</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">mapper</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">frame_allocator</span><span class="p">)</span>
        <span class="nf">.expect</span><span class="p">(</span><span class="s">"heap initialization failed"</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">41</span><span class="p">);</span> <span class="c1">// for test</span>
</pre></table></code></div></div><h3 id="allocator-crate"><span class="mr-2">Allocator Crate</span><a href="#allocator-crate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We are going to use the <a href="https://crates.io/crates/linked_list_allocator">linked_list_allocator</a> crate for our allocator. To add it, we include it as a dependency:</p><div file="Cargo.toml" class="language-toml highlighter-rouge"><div class="code-header"> <span data-label-text="Cargo.toml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nn">[dependencies]</span>
<span class="py">linked_list_allocator</span> <span class="p">=</span> <span class="s">"0.9.0"</span>
</pre></table></code></div></div><p>We can replace the <code class="language-plaintext highlighter-rouge">dummy</code> allocator with it:</p><div file="src/allocator.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/allocator.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">linked_list_allocator</span><span class="p">::</span><span class="n">LockedHeap</span><span class="p">;</span>

<span class="nd">#[global_allocator]</span>
<span class="k">static</span> <span class="n">ALLOCATOR</span><span class="p">:</span> <span class="n">LockedHeap</span> <span class="o">=</span> <span class="nn">LockedHeap</span><span class="p">::</span><span class="nf">empty</span><span class="p">();</span>
</pre></table></code></div></div><p>Now, we need to initialize the allocator after creating the heap:</p><div file="src/allocator.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/allocator.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">init_heap</span><span class="p">(</span>
    <span class="n">mapper</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">impl</span> <span class="n">Mapper</span><span class="o">&lt;</span><span class="n">Size4KiB</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">frame_allocator</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">impl</span> <span class="n">FrameAllocator</span><span class="o">&lt;</span><span class="n">Size4KiB</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">MapToError</span><span class="o">&lt;</span><span class="n">Size4KiB</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
  <span class="p">[</span><span class="o">...</span><span class="p">]</span>

  <span class="k">unsafe</span> <span class="p">{</span>
        <span class="n">ALLOCATOR</span><span class="nf">.lock</span><span class="p">()</span><span class="nf">.init</span><span class="p">(</span><span class="n">HEAP_START</span><span class="p">,</span> <span class="n">HEAP_SIZE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="testing"><span class="mr-2">Testing</span><a href="#testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can go back to <code class="language-plaintext highlighter-rouge">kernel_main</code> and test it as follows:</p><div file="src/main.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/main.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">kernel_main</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="n">BootInfo</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">zeros</span><span class="p">::</span><span class="n">allocator</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">zeros</span><span class="p">::</span><span class="nn">memory</span><span class="p">::{</span><span class="k">self</span><span class="p">,</span> <span class="n">BootInfoFrameAllocator</span><span class="p">};</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="n">VirtAddr</span><span class="p">;</span>

    <span class="nn">zeros</span><span class="p">::</span><span class="nf">init</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">phys_mem_offset</span> <span class="o">=</span> <span class="nn">VirtAddr</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">boot_info</span><span class="py">.physical_memory_offset</span><span class="p">);</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">memory</span><span class="p">::</span><span class="nf">init</span><span class="p">(</span><span class="n">phys_mem_offset</span><span class="p">)</span> <span class="p">};</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">frame_allocator</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">BootInfoFrameAllocator</span><span class="p">::</span><span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_info</span><span class="py">.memory_map</span><span class="p">)</span> <span class="p">};</span>

    <span class="nn">allocator</span><span class="p">::</span><span class="nf">init_heap</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">mapper</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">frame_allocator</span><span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"heap initialization failed"</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">heap_value</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">41</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"heap_value at {:p}"</span><span class="p">,</span> <span class="n">heap_value</span><span class="p">);</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">vec</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="mi">500</span> <span class="p">{</span>
        <span class="n">vec</span><span class="nf">.push</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"vec at {:p}"</span><span class="p">,</span> <span class="n">vec</span><span class="nf">.as_slice</span><span class="p">());</span>

    <span class="k">let</span> <span class="n">reference_counted</span> <span class="o">=</span> <span class="nn">Rc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
    <span class="k">let</span> <span class="n">cloned_reference</span> <span class="o">=</span> <span class="n">reference_counted</span><span class="nf">.clone</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"current reference count is {}"</span><span class="p">,</span>
        <span class="nn">Rc</span><span class="p">::</span><span class="nf">strong_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cloned_reference</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="nn">core</span><span class="p">::</span><span class="nn">mem</span><span class="p">::</span><span class="nf">drop</span><span class="p">(</span><span class="n">reference_counted</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span>
        <span class="s">"reference count is {} now"</span><span class="p">,</span>
        <span class="nn">Rc</span><span class="p">::</span><span class="nf">strong_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cloned_reference</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="nn">zeros</span><span class="p">::</span><span class="nf">hlt_loop</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p><a href="/assets/img/osdev/2023-04-27_20-20.png" class="popup img-link "><img data-src="/assets/img/osdev/2023-04-27_20-20.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Heap Allocation</em></p><p><br /></p><hr /><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Images done on <a href="https://www.figma.com/">Figma</a><li><a href="https://os.phil-opp.com/paging-introduction/">Introduction to Paging</a><li><a href="https://os.phil-opp.com/paging-implementation/">Paging Implementation</a><li><a href="https://en.wikipedia.org/wiki/Call_stack">Call Stack</a><li><a href="https://os.phil-opp.com/heap-allocation/">Heap Allocation</a><li><a href="https://os.phil-opp.com/allocator-designs/">Allocator Designs</a></ul><p><br /></p><hr /><h2 id="footnotes"><span class="mr-2">Footnotes</span><a href="#footnotes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="footnotes" role="doc-endnotes"><ol><li id="fn:footnote" role="doc-endnote"><p>is a stack data structure that stores information about the active subroutines of a computer program. <a href="#fnref:footnote" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/lowlevel/'>LowLevel</a>, <a href='/categories/osdev/'>OSDev</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/lowlevel/" class="post-tag no-text-decoration" >lowlevel</a> <a href="/tags/osdev/" class="post-tag no-text-decoration" >osdev</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=OSDev%20%7C%20Chapter%204%20%7C%20Memory%20Management%20-%20Zeropio's%20Dojo&url=https%3A%2F%2Fzeropio.ninja%2F%2Flowlevel%2Fosdev%2Fchapter-4" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=OSDev%20%7C%20Chapter%204%20%7C%20Memory%20Management%20-%20Zeropio's%20Dojo&u=https%3A%2F%2Fzeropio.ninja%2F%2Flowlevel%2Fosdev%2Fchapter-4" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fzeropio.ninja%2F%2Flowlevel%2Fosdev%2Fchapter-4&text=OSDev%20%7C%20Chapter%204%20%7C%20Memory%20Management%20-%20Zeropio's%20Dojo" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/index">Index</a><li><a href="/sensei/shellcode-blacksmith">The Shellcode Blacksmith | Sensei</a><li><a href="/lowlevel/osdev/chapter-0">OSDev | Chapter 0 | Basic Kernel</a><li><a href="/malware/development/putty-1">MalDev | Putty</a><li><a href="/malware/development/dropper-explorer-1">MalDev | Dropper Explorer.exe</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/lowlevel/">lowlevel</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/osdev/">osdev</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/reversing/">reversing</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/lowlevel/osdev/chapter-0"><div class="card-body"> <em class="small" data-ts="1681336800" data-df="ll" > Apr 13, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OSDev | Chapter 0 | Basic Kernel</h3><div class="text-muted small"><p> Introduction This series, is a personal project focused on learning more about ASM, kernel development, computer basics, and Rust. This is not a professional blog, and I will be using resources fr...</p></div></div></a></div><div class="card"> <a href="/lowlevel/osdev/chapter-1"><div class="card-body"> <em class="small" data-ts="1681596000" data-df="ll" > Apr 16, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OSDev | Chapter 1 | Freestanding Rust</h3><div class="text-muted small"><p> Introduction The kernel will be written in Rust, which is why we need to do some preparations before starting to code. This will not be the beginning of development, but rather the setup phase. Th...</p></div></div></a></div><div class="card"> <a href="/lowlevel/osdev/chapter-2"><div class="card-body"> <em class="small" data-ts="1681682400" data-df="ll" > Apr 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OSDev | Chapter 2 | Rust Kernel</h3><div class="text-muted small"><p> Introduction Now that we have a freestanding Rust binary, the next step is to create the kernel. We will create a 64-bit kernel for the x86 architecture. As we saw in the first chapter, we will be...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/lowlevel/osdev/chapter-3" class="btn btn-outline-primary" prompt="Older"><p>OSDev | Chapter 3 | Interrupts</p></a> <a href="/sensei/shellcode-blacksmith" class="btn btn-outline-primary" prompt="Newer"><p>The Shellcode Blacksmith | Sensei</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/lowlevel/">lowlevel</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/osdev/">osdev</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/reversing/">reversing</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ZeropioWasTaken">zeropio</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
