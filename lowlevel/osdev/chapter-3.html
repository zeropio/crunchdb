<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="OSDev Chapter 3 Interrupts" /><meta name="author" content="Zeropio" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://zeropio.ninja//lowlevel/osdev/chapter-3" /><meta property="og:url" content="https://zeropio.ninja//lowlevel/osdev/chapter-3" /><meta property="og:site_name" content="Zeropio’s Dojo" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-26T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="OSDev Chapter 3 Interrupts" /><meta name="twitter:site" content="@ZeropioWasTaken" /><meta name="twitter:creator" content="@ZeropioWasTaken" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zeropio","url":"https://twitter.com/ZeropioWasTaken"},"dateModified":"2023-05-09T11:14:07+02:00","datePublished":"2023-04-26T00:00:00+02:00","description":"Introduction","headline":"OSDev Chapter 3 Interrupts","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeropio.ninja//lowlevel/osdev/chapter-3"},"url":"https://zeropio.ninja//lowlevel/osdev/chapter-3"}</script><title>OSDev | Chapter 3 | Interrupts | Zeropio's Dojo</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Zeropio's Dojo"><meta name="application-name" content="Zeropio's Dojo"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/icon.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Zeropio's Dojo</a></div><div class="site-subtitle font-italic">Cyberninja</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zeropio" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://ctftime.org/team/212175" aria-label="ctftime" target="_blank" rel="noopener noreferrer"> <i class="fas fa-flag"></i> </a> <a href="https://app.hackthebox.com/profile/380109" aria-label="hackthebox" target="_blank" rel="noopener noreferrer"> <i class="fas fa-cube"></i> </a> <a href="https://twitter.com/ZeropioWasTaken" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>OSDev | Chapter 3 | Interrupts</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>OSDev | Chapter 3 | Interrupts</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1682460000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 26, 2023 </em> </span> <span> Updated <em class="" data-ts="1683623647" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 9, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/ZeropioWasTaken">Zeropio</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2378 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To create a functional OS, it is essential to handle errors such as division by zero, attempts to access non-existent memory addresses, and other potential issues. One approach to handling errors is to create an <em>interrupt descriptor table</em><sup id="fnref:footnote" role="doc-noteref"><a href="#fn:footnote" class="footnote" rel="footnote">1</a></sup>. Additionally, using different structs can also provide a better understanding of the system’s overall structure and organization.</p><p><br /></p><hr /><h2 id="cpu-exceptions"><span class="mr-2">CPU Exceptions</span><a href="#cpu-exceptions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Exceptions occur when an error happens, causing the CPU to stop its current work and call an exception handler function. Some types of exceptions are:</p><h4>Faults</h4><ul><li><strong>Division Error</strong>: occurs when dividing by 0 using <code class="language-plaintext highlighter-rouge">DIV</code> or <code class="language-plaintext highlighter-rouge">IDIV</code>.<li><strong>Invalid Opcode</strong>: happens when the processor tries to execute an invalid, undefined opcode, or with invalid prefixes.<li><strong>Stack-Segment Fault</strong>: occurs when loading a stack-segment referencing a segment descriptor that is not present, pushing or popping any instruction using ESP or EBP, or when the stack-limit check fails.<li><strong>General Protection Fault</strong>: can occur due to a segment error, executing a privileged instruction while <code class="language-plaintext highlighter-rouge">CPL != 0</code><sup id="fnref:fn-nth-2" role="doc-noteref"><a href="#fn:fn-nth-2" class="footnote" rel="footnote">2</a></sup>, writing a 1 in a reserved register field or writing invalid value combinations, or referencing or accessing a null-descriptor.<li><strong>Page Fault</strong>: happens when a page directory or table entry is not present in physical memory, when a protection check fails, or when the reserved bit in the page directory or table entries is set to 1.</ul><h4>Traps</h4><ul><li><strong>Debug</strong>: can occur due to various reasons such as instruction fetch breakpoint (Fault), general detect condition (Fault), data read or write breakpoint (Trap), I/O read or write breakpoint (Trap), Single-step (Trap), or Task-switch (Trap).<li><strong>Breakpoint</strong>: occurs when the INT3 instruction is executed.<li><strong>Overflow</strong>: occurs when the INTO instruction is executed while the overflow bit in RFLAGS is set to 1.</ul><h4>Aborts</h4><ul><li><strong>Double Fault</strong>: occurs when an exception is unhandled or when an exception occurs while the CPU is trying to call an exception handler.<li><strong>Triple Fault</strong>: not really an exception as it doesn’t have an associated vector number. It occurs when an exception is generated when an attempt is made to call the double fault exception handler.</ul><p>To build the <strong>IDT</strong> (<strong>I</strong>nterrupt <strong>D</strong>escriptor <strong>T</strong>able), we need to add values in the 16-byte structure because the hardware accesses this table. Each entry must include the following fields:</p><div class="table-wrapper"><table><thead><tr><th><strong>Type</strong><th><strong>Name</strong><th><strong>Description</strong><tbody><tr><td><code class="language-plaintext highlighter-rouge">u16</code><td>Function Pointer [0:15]<td>Lower bits of the pointer to the handler function<tr><td><code class="language-plaintext highlighter-rouge">u16</code><td>GDT selector<td>Selector in the <em>Global Descriptor Table</em><sup id="fnref:fn-nth-3" role="doc-noteref"><a href="#fn:fn-nth-3" class="footnote" rel="footnote">3</a></sup><tr><td><code class="language-plaintext highlighter-rouge">u16</code><td>Options<td>(second table)<tr><td><code class="language-plaintext highlighter-rouge">u16</code><td>Function Pointer [16:31]<td>Middle bits of the pointer<tr><td><code class="language-plaintext highlighter-rouge">u32</code><td>Function Pointer [32:63]<td>Lasts bits of the pointer<tr><td><code class="language-plaintext highlighter-rouge">u32</code><td>Reserved<td> </table></div><p>The <em>options</em> fields follow this format:</p><div class="table-wrapper"><table><thead><tr><th><strong>Bits</strong><th><strong>Name</strong><th><strong>Description</strong><tbody><tr><td>0 - 2<td><strong>Interrupt Stack Table Index</strong><td>0: Don’t switch stacks, 1-7: Switch to the n-th stack in the Interrupt Stack Table when this handler is called<tr><td>3 - 7<td>Reserved<td> <tr><td>8<td>Gate<td>If 0 (<em>Interrupt Gate</em>), interrupts are disabled when this handler is called<tr><td>9 - 11<td>must be 1<td> <tr><td>12<td>must be 0<td> <tr><td>13 - 14<td><strong>Descriptor Privilege Level</strong> (<strong>DPL</strong>)<td>minimal privilege level required for calling this handler<tr><td>15<td>Present<td> </table></div><p>When a exception is called, the following occurs on the CPU:</p><ol><li>The registers are pushed onto the stack.<li>The entry from the <strong>IDT</strong> is read.<li>If the entry is not present, a double fault is raised.<li>If the entry is an interrupt gate, hardware interrupts are disabled.<li>The <strong>GDT</strong> is loaded into the <em>code segment</em>.<li>The specified handler function is then executed.</ol><h3 id="idt-structure"><span class="mr-2">IDT Structure</span><a href="#idt-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Rust already provides an <a href="https://docs.rs/x86_64/0.14.2/x86_64/structures/idt/struct.InterruptDescriptorTable.html">IDT</a> that we can use:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nd">#[repr(C)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">InterruptDescriptorTable</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">divide_by_zero</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">debug</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">non_maskable_interrupt</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">breakpoint</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">overflow</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">bound_range_exceeded</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">invalid_opcode</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">device_not_available</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">double_fault</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFuncWithErrCode</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">invalid_tss</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFuncWithErrCode</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">segment_not_present</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFuncWithErrCode</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">stack_segment_fault</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFuncWithErrCode</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">general_protection_fault</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFuncWithErrCode</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">page_fault</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">PageFaultHandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">x87_floating_point</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">alignment_check</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFuncWithErrCode</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">machine_check</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">simd_floating_point</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">virtualization</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFunc</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">security_exception</span><span class="p">:</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">HandlerFuncWithErrCode</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We will modify <code class="language-plaintext filepath highlighter-rouge">src/lib.rs</code> and create a new <code class="language-plaintext filepath highlighter-rouge">src/interrupts.rs</code> file to create an interrupts module.</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">mod</span> <span class="n">interrupts</span><span class="p">;</span>
</pre></table></code></div></div><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">structures</span><span class="p">::</span><span class="nn">idt</span><span class="p">::</span><span class="n">InterruptDescriptorTable</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">init_idt</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">idt</span> <span class="o">=</span> <span class="nn">InterruptDescriptorTable</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We can start by implementing the breakpoint exception, which occurs when the <code class="language-plaintext highlighter-rouge">int3</code> instruction is executed:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">structures</span><span class="p">::</span><span class="nn">idt</span><span class="p">::{</span><span class="n">InterruptDescriptorTable</span><span class="p">,</span> <span class="n">InterruptStackFrame</span><span class="p">};</span>
<span class="k">use</span> <span class="k">crate</span><span class="p">::</span><span class="n">println</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">init_idt</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">idt</span> <span class="o">=</span> <span class="nn">InterruptDescriptorTable</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="n">idt</span><span class="py">.breakpoint</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">breakpoint_handler</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">breakpoint_handler</span><span class="p">(</span><span class="n">stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"EXCEPTION: BREAKPOINT</span><span class="se">\n</span><span class="s">{:#?}"</span><span class="p">,</span> <span class="n">stack_frame</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This will drop an error, so we need to add <code class="language-plaintext highlighter-rouge">#![feature(abi_x86_interrupt)]</code> to <code class="language-plaintext filepath highlighter-rouge">lib.rs</code> to handle it.</p><h3 id="loading-the-idt"><span class="mr-2">Loading the IDT</span><a href="#loading-the-idt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can load the IDT as follows:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">init_idt</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">idt</span> <span class="o">=</span> <span class="nn">InterruptDescriptorTable</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="n">idt</span><span class="py">.breakpoint</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">breakpoint_handler</span><span class="p">);</span>
    <span class="n">idt</span><span class="nf">.load</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>However, this will drop an error because <code class="language-plaintext highlighter-rouge">idt</code> is borrowed. To handle it, we can use the <code class="language-plaintext highlighter-rouge">lazy_static</code> macro again:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">lazy_static</span><span class="p">::</span><span class="n">lazy_static</span><span class="p">;</span>

<span class="nd">lazy_static!</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">ref</span> <span class="n">IDT</span><span class="p">:</span> <span class="n">InterruptDescriptorTable</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">idt</span> <span class="o">=</span> <span class="nn">InterruptDescriptorTable</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="n">idt</span><span class="py">.breakpoint</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">breakpoint_handler</span><span class="p">);</span>
        <span class="n">idt</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">init_idt</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">IDT</span><span class="nf">.load</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now, add the function to <code class="language-plaintext filepath highlighter-rouge">lib.rs</code>:</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nn">interrupts</span><span class="p">::</span><span class="nf">init_idt</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And modify the <code class="language-plaintext highlighter-rouge">_start</code> function to call the handler:</p><div file="src/main.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/main.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">_start</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">);</span>

    <span class="nn">zeros</span><span class="p">::</span><span class="nf">init</span><span class="p">();</span>

    <span class="nn">x86_64</span><span class="p">::</span><span class="nn">instructions</span><span class="p">::</span><span class="nn">interrupts</span><span class="p">::</span><span class="nf">int3</span><span class="p">();</span>

    <span class="nd">#[cfg(test)]</span>
    <span class="nf">test_main</span><span class="p">();</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"It did not crash!"</span><span class="p">);</span>
    <span class="k">loop</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="error-visualizer"><span class="mr-2">Error Visualizer</span><a href="#error-visualizer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Finally, we can see the error on screen:</p><p><a href="/assets/img/osdev/2023-04-26_17-41.png" class="popup img-link "><img data-src="/assets/img/osdev/2023-04-26_17-41.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Exception Handled</em></p><p><br /></p><hr /><h2 id="double-faults"><span class="mr-2">Double Faults</span><a href="#double-faults" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To avoid triple faults (which restart the system), we need to handle double faults. As mentioned before, a double fault occurs when the CPU fails to invoke an exception handler. We can easily provoke this error with the following code:</p><div file="src/main.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/main.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nn">zeros</span><span class="p">::</span><span class="nf">init</span><span class="p">();</span>

<span class="k">unsafe</span> <span class="p">{</span>
    <span class="o">*</span><span class="p">(</span><span class="mi">0xdeadc0ffe</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u64</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1337</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This will cause the kernel to crash.</p><h3 id="the-handler"><span class="mr-2">The Handler</span><a href="#the-handler" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To handle double faults, we need to add some lines to <code class="language-plaintext filepath highlighter-rouge">interrupts.rs</code>. We need to add a new entry to the IDT and define a new function for it:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">lazy_static!</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">ref</span> <span class="n">IDT</span><span class="p">:</span> <span class="n">InterruptDescriptorTable</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">idt</span> <span class="o">=</span> <span class="nn">InterruptDescriptorTable</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="n">idt</span><span class="py">.breakpoint</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">breakpoint_handler</span><span class="p">);</span>
        <span class="n">idt</span><span class="py">.double_fault</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">double_fault_handler</span><span class="p">);</span> <span class="c1">// double fault added</span>
        <span class="n">idt</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">double_fault_handler</span><span class="p">(</span><span class="n">stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">,</span> <span class="n">_error_code</span><span class="p">:</span> <span class="nb">u64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="nd">panic!</span><span class="p">(</span><span class="s">"EXCEPTION: DOUBLE FAULT</span><span class="se">\n</span><span class="s">{:#?}"</span><span class="p">,</span> <span class="n">stack_frame</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="kernel-stack-overflow-and-switching-stacks"><span class="mr-2">Kernel Stack Overflow and Switching Stacks</span><a href="#kernel-stack-overflow-and-switching-stacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can easily create a stack overflow by creating an infinite loop:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">stack_overflow</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">stack_overflow</span><span class="p">();</span> <span class="c1">// for each recursion, the return address is pushed</span>
<span class="p">}</span>

<span class="nf">stack_overflow</span><span class="p">();</span>
</pre></table></code></div></div><p>This will cause the OS to enter an infinite restart loop:</p><p><a href="/assets/img/osdev/2023-04-26-18-40.gif" class="popup img-link "><img data-src="/assets/img/osdev/2023-04-26-18-40.gif" alt="" class="lazyload" data-proofer-ignore></a> <em>Kernel Stack Overflow</em></p><p>To prevent this error, we can use <strong>Switching Stacks</strong>. This is implemented as the <strong>IST</strong> (<strong>I</strong>nterrupt <strong>S</strong>tack <strong>T</strong>able), which is a table of 7 pointers to known-good stacks. It is part of an older structure called the <strong>TSS</strong> (<strong>T</strong>ask <strong>S</strong>tate <strong>S</strong>egment), which was used to save some information for hardware context switching. However, in 64-bit systems, hardware context switching is no longer supported.</p><p>In 64-bit systems, the TSS holds the IST and the <strong>Privilege Stack Table</strong>.</p><p>Now, we will create a <strong>Global Descriptor Table</strong> file (<code class="language-plaintext filepath highlighter-rouge">src/gdt.rs</code>). Add the following line to <code class="language-plaintext filepath highlighter-rouge">lib.rs</code>:</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">mod</span> <span class="n">gdt</span><span class="p">;</span>
</pre></table></code></div></div><p>In the newly created <code class="language-plaintext filepath highlighter-rouge">gdt.rs</code> file, we create the TTS:</p><div file="src/gdt.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/gdt.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="n">VirtAddr</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">structures</span><span class="p">::</span><span class="nn">tss</span><span class="p">::</span><span class="n">TaskStateSegment</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">lazy_static</span><span class="p">::</span><span class="n">lazy_static</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">const</span> <span class="n">DOUBLE_FAULT_IST_INDEX</span><span class="p">:</span> <span class="nb">u16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nd">lazy_static!</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">ref</span> <span class="n">TSS</span><span class="p">:</span> <span class="n">TaskStateSegment</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">tss</span> <span class="o">=</span> <span class="nn">TaskStateSegment</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="n">tss</span><span class="py">.interrupt_stack_table</span><span class="p">[</span><span class="n">DOUBLE_FAULT_IST_INDEX</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">const</span> <span class="n">STACK_SIZE</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
            <span class="k">static</span> <span class="k">mut</span> <span class="n">STACK</span><span class="p">:</span> <span class="p">[</span><span class="nb">u8</span><span class="p">;</span> <span class="n">STACK_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="n">STACK_SIZE</span><span class="p">];</span>

            <span class="k">let</span> <span class="n">stack_start</span> <span class="o">=</span> <span class="nn">VirtAddr</span><span class="p">::</span><span class="nf">from_ptr</span><span class="p">(</span><span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">STACK</span> <span class="p">});</span>
            <span class="k">let</span> <span class="n">stack_end</span> <span class="o">=</span> <span class="n">stack_start</span> <span class="o">+</span> <span class="n">STACK_SIZE</span><span class="p">;</span>
            <span class="n">stack_end</span>
        <span class="p">};</span>
        <span class="n">tss</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div><p>With the TSS created, we need to create the GDT:</p><div file="src/gdt.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/gdt.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">structures</span><span class="p">::</span><span class="nn">gdt</span><span class="p">::{</span><span class="n">GlobalDescriptorTable</span><span class="p">,</span> <span class="n">Descriptor</span><span class="p">,</span> <span class="n">SegmentSelector</span><span class="p">};</span>

<span class="nd">lazy_static!</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">ref</span> <span class="n">GDT</span><span class="p">:</span> <span class="p">(</span><span class="n">GlobalDescriptorTable</span><span class="p">,</span> <span class="n">Selectors</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">gdt</span> <span class="o">=</span> <span class="nn">GlobalDescriptorTable</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">code_selector</span> <span class="o">=</span> <span class="n">gdt</span><span class="nf">.add_entry</span><span class="p">(</span><span class="nn">Descriptor</span><span class="p">::</span><span class="nf">kernel_code_segment</span><span class="p">());</span>
        <span class="k">let</span> <span class="n">tss_selector</span> <span class="o">=</span> <span class="n">gdt</span><span class="nf">.add_entry</span><span class="p">(</span><span class="nn">Descriptor</span><span class="p">::</span><span class="nf">tss_segment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TSS</span><span class="p">));</span>
        <span class="p">(</span><span class="n">gdt</span><span class="p">,</span> <span class="n">Selectors</span> <span class="p">{</span> <span class="n">code_selector</span><span class="p">,</span> <span class="n">tss_selector</span> <span class="p">})</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Selectors</span> <span class="p">{</span>
    <span class="n">code_selector</span><span class="p">:</span> <span class="n">SegmentSelector</span><span class="p">,</span>
    <span class="n">tss_selector</span><span class="p">:</span> <span class="n">SegmentSelector</span><span class="p">,</span>
<span class="p">}</span>
</pre></table></code></div></div><p>To load the GDT, create an <code class="language-plaintext highlighter-rouge">ìnit()</code> function:</p><div file="src/gdt.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/gdt.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">instructions</span><span class="p">::</span><span class="nn">tables</span><span class="p">::</span><span class="n">load_tss</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">instructions</span><span class="p">::</span><span class="nn">segmentation</span><span class="p">::{</span><span class="n">CS</span><span class="p">,</span> <span class="n">Segment</span><span class="p">};</span>

    <span class="n">GDT</span><span class="na">.0</span><span class="nf">.load</span><span class="p">();</span>
    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="nn">CS</span><span class="p">::</span><span class="nf">set_reg</span><span class="p">(</span><span class="n">GDT</span><span class="na">.1</span><span class="py">.code_selector</span><span class="p">);</span>
        <span class="nf">load_tss</span><span class="p">(</span><span class="n">GDT</span><span class="na">.1</span><span class="py">.tss_selector</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And load it into <code class="language-plaintext filepath highlighter-rouge">lib.rs</code>:</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nn">gdt</span><span class="p">::</span><span class="nf">init</span><span class="p">();</span>
    <span class="nn">interrupts</span><span class="p">::</span><span class="nf">init_idt</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Finally, we need to add <code class="language-plaintext highlighter-rouge">.set_stack_index(gdt::DOUBLE_FAULT_IST_INDEX);</code> to the <code class="language-plaintext highlighter-rouge">double_fault_handler</code> on <code class="language-plaintext filepath highlighter-rouge">interrupts.rs</code> inside an <code class="language-plaintext highlighter-rouge">unsafe</code> block. And modify the function to:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">double_fault_handler</span><span class="p">(</span><span class="n">stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">,</span> <span class="n">_error_code</span><span class="p">:</span> <span class="nb">u64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="nd">panic!</span><span class="p">(</span><span class="s">"EXCEPTION: DOUBLE FAULT</span><span class="se">\n</span><span class="s">{:#?}"</span><span class="p">,</span> <span class="n">stack_frame</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And now, when a kernel stack overflow happens the OS will stop:</p><p><a href="/assets/img/osdev/2023-04-26_19-04.png" class="popup img-link "><img data-src="/assets/img/osdev/2023-04-26_19-04.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Double Fault Handled</em></p><p><br /></p><hr /><h2 id="hardware-interrupts"><span class="mr-2">Hardware Interrupts</span><a href="#hardware-interrupts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Hardware interrupts allow us to notify the CPU about some attached hardware. Instead of checking if the keyboard is pressed every time we press it, an instruction will be sent to the kernel. First, we need to create an <strong>Interrupt Controller</strong>, because we can’t attach an unlimited amount of hardware to the CPU.</p><p>To create the interrupt controller, we will simulate the <em>8259</em> and <em>8259A</em> <strong>PICs</strong> (<strong>P</strong>rogrammable <strong>I</strong>nterrupt <strong>C</strong>ontrollers) with the <a href="https://crates.io/crates/pic8259">pic8259</a> crate. Add it to the dependencies:</p><div file="Cargo.toml" class="language-toml highlighter-rouge"><div class="code-header"> <span data-label-text="Cargo.toml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nn">[dependencies]</span>
<span class="py">pic8259</span> <span class="p">=</span> <span class="s">"0.10.1"</span>
</pre></table></code></div></div><p>In <code class="language-plaintext filepath highlighter-rouge">src/interrupts.rs</code> we need to create the <code class="language-plaintext highlighter-rouge">ChainedPics</code> struct that the crate provides:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">pic8259</span><span class="p">::</span><span class="n">ChainedPics</span><span class="p">;</span>
<span class="k">use</span> <span class="n">spin</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">const</span> <span class="n">PIC_1_OFFSET</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">const</span> <span class="n">PIC_2_OFFSET</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">PIC_1_OFFSET</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">static</span> <span class="n">PICS</span><span class="p">:</span> <span class="nn">spin</span><span class="p">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">ChainedPics</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">spin</span><span class="p">::</span><span class="nn">Mutex</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">unsafe</span> <span class="p">{</span> <span class="nn">ChainedPics</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">PIC_1_OFFSET</span><span class="p">,</span> <span class="n">PIC_2_OFFSET</span><span class="p">)</span> <span class="p">});</span>
</pre></table></code></div></div><p>We can now initiliaze it in <code class="language-plaintext filepath highlighter-rouge">lib.rs</code> and allow interrupts:</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nn">gdt</span><span class="p">::</span><span class="nf">init</span><span class="p">();</span>
    <span class="nn">interrupts</span><span class="p">::</span><span class="nf">init_idt</span><span class="p">();</span>
    <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">interrupts</span><span class="p">::</span><span class="n">PICS</span><span class="nf">.lock</span><span class="p">()</span><span class="nf">.initialize</span><span class="p">()</span> <span class="p">};</span>
    <span class="nn">x86_64</span><span class="p">::</span><span class="nn">instructions</span><span class="p">::</span><span class="nn">interrupts</span><span class="p">::</span><span class="nf">enable</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>However, executing it will drop an error. This happens because interrupts are enabled, and the system is waiting for time interrupts.</p><p><a href="/assets/img/osdev/2023-04-26_19-47.png" class="popup img-link "><img data-src="/assets/img/osdev/2023-04-26_19-47.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Double Fault Error</em></p><h3 id="handling-time-interrupts"><span class="mr-2">Handling Time Interrupts</span><a href="#handling-time-interrupts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We create a C-like enum for the interrupt:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Copy)]</span>
<span class="nd">#[repr(u8)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">InterruptIndex</span> <span class="p">{</span>
    <span class="n">Timer</span> <span class="o">=</span> <span class="n">PIC_1_OFFSET</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">InterruptIndex</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">as_u8</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span> <span class="p">{</span>
        <span class="k">self</span> <span class="k">as</span> <span class="nb">u8</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">as_usize</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="nn">usize</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="k">self</span><span class="nf">.as_u8</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now we can add a new handler to the IDT::</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">idt</span><span class="p">[</span><span class="nn">InterruptIndex</span><span class="p">::</span><span class="n">Timer</span><span class="nf">.as_usize</span><span class="p">()]</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">timer_interrupt_handler</span><span class="p">);</span>
</pre></table></code></div></div><p>And add the function:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">timer_interrupt_handler</span><span class="p">(</span><span class="n">_stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">print!</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now the system wait without crashing. But a new problem arises: we need to specify the <strong>EOI</strong> (<strong>E</strong>nd <strong>O</strong>f <strong>I</strong>nterrupt) to say that the current interrupt has ended and start the following:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">timer_interrupt_handler</span><span class="p">(</span><span class="n">_stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">print!</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>

    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="n">PICS</span><span class="nf">.lock</span><span class="p">()</span><span class="nf">.notify_end_of_interrupt</span><span class="p">(</span><span class="nn">InterruptIndex</span><span class="p">::</span><span class="n">Timer</span><span class="nf">.as_u8</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This will print the text an unlimited times.</p><p><a href="/assets/img/osdev/2023-04-26_20-01.png" class="popup img-link "><img data-src="/assets/img/osdev/2023-04-26_20-01.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Printing</em></p><h3 id="deadlocks"><span class="mr-2">Deadlocks</span><a href="#deadlocks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Deadlocks occurs if a thread tries to lock a process. The print we used provokes one, not allowing the rest of the kernel to execute. To avoid this error we can modify the function <code class="language-plaintext highlighter-rouge">print</code> from <code class="language-plaintext filepath highlighter-rouge">vga_buffer.rs</code>:</p><div file="src/vga_buffer.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/vga_buffer.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">#[doc(hidden)]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">_print</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nn">fmt</span><span class="p">::</span><span class="n">Arguments</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">core</span><span class="p">::</span><span class="nn">fmt</span><span class="p">::</span><span class="n">Write</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">instructions</span><span class="p">::</span><span class="n">interrupts</span><span class="p">;</span>

    <span class="nn">interrupts</span><span class="p">::</span><span class="nf">without_interrupts</span><span class="p">(||</span> <span class="p">{</span>
        <span class="n">WRITER</span><span class="nf">.lock</span><span class="p">()</span><span class="nf">.write_fmt</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="htl-instruction"><span class="mr-2">htl Instruction</span><a href="#htl-instruction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We have used a <code class="language-plaintext highlighter-rouge">loop{}</code> at the end of the <code class="language-plaintext highlighter-rouge">_start</code> function to make it run, but this is a poorly efficient way of doing it. This makes the CPU works at full speed even though there is no work to do. We need to <em>halt</em> the CPU until the next interrupts, so the CPU enters in a sleep mode until then.</p><p>For this, we create a new function:</p><div file="src/lib.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/lib.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">hlt_loop</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="k">loop</span> <span class="p">{</span>
        <span class="nn">x86_64</span><span class="p">::</span><span class="nn">instructions</span><span class="p">::</span><span class="nf">hlt</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And now replace the <code class="language-plaintext highlighter-rouge">loop{}</code> with <code class="language-plaintext highlighter-rouge">zeros::hlt_loop()</code>.</p><h3 id="keyboard-input"><span class="mr-2">Keyboard Input</span><a href="#keyboard-input" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>With everything set, we can now add keyboard input. We need to handle a new interrupt this time:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Copy)]</span>
<span class="nd">#[repr(u8)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">InterruptIndex</span> <span class="p">{</span>
    <span class="n">Timer</span> <span class="o">=</span> <span class="n">PIC_1_OFFSET</span><span class="p">,</span>
    <span class="n">Keyboard</span>
<span class="p">}</span>

<span class="nd">lazy_static!</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">ref</span> <span class="n">IDT</span><span class="p">:</span> <span class="n">InterruptDescriptorTable</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">idt</span> <span class="o">=</span> <span class="nn">InterruptDescriptorTable</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="n">idt</span><span class="py">.breakpoint</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">breakpoint_handler</span><span class="p">);</span>
        <span class="k">unsafe</span> <span class="p">{</span><span class="n">idt</span><span class="py">.double_fault</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">double_fault_handler</span><span class="p">)</span><span class="nf">.set_stack_index</span><span class="p">(</span><span class="nn">gdt</span><span class="p">::</span><span class="n">DOUBLE_FAULT_IST_INDEX</span><span class="p">);}</span>
        <span class="n">idt</span><span class="p">[</span><span class="nn">InterruptIndex</span><span class="p">::</span><span class="n">Timer</span><span class="nf">.as_usize</span><span class="p">()]</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">timer_interrupt_handler</span><span class="p">);</span>
        <span class="n">idt</span><span class="p">[</span><span class="nn">InterruptIndex</span><span class="p">::</span><span class="n">Keyboard</span><span class="nf">.as_usize</span><span class="p">()]</span><span class="nf">.set_handler_fn</span><span class="p">(</span><span class="n">keyboard_interrupt_handler</span><span class="p">);</span>
        <span class="n">idt</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">keyboard_interrupt_handler</span><span class="p">(</span><span class="n">_stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">print!</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="n">PICS</span><span class="nf">.lock</span><span class="p">()</span><span class="nf">.notify_end_of_interrupt</span><span class="p">(</span><span class="nn">InterruptIndex</span><span class="p">::</span><span class="n">Keyboard</span><span class="nf">.as_u8</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now we need to read the codes we input:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">keyboard_interrupt_handler</span><span class="p">(</span>
    <span class="n">_stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">instructions</span><span class="p">::</span><span class="nn">port</span><span class="p">::</span><span class="n">Port</span><span class="p">;</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">port</span> <span class="o">=</span> <span class="nn">Port</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">0x60</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">scancode</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">port</span><span class="nf">.read</span><span class="p">()</span> <span class="p">};</span>
    <span class="nd">print!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>

    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="n">PICS</span><span class="nf">.lock</span><span class="p">()</span><span class="nf">.notify_end_of_interrupt</span><span class="p">(</span><span class="nn">InterruptIndex</span><span class="p">::</span><span class="n">Keyboard</span><span class="nf">.as_u8</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>But we have <em>scancodes</em> instead of actual characters. We can use the <a href="https://crates.io/crates/pc-keyboard">pc-keyboard</a> crate for this. Import it:</p><div file="Cargo.toml" class="language-toml highlighter-rouge"><div class="code-header"> <span data-label-text="Cargo.toml"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nn">[dependencies]</span>
<span class="py">pc-keyboard</span> <span class="p">=</span> <span class="s">"0.5.0"</span>
</pre></table></code></div></div><p>And modify the previous code:</p><div file="src/interrupts.rs" class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="src/interrupts.rs"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="s">"x86-interrupt"</span> <span class="k">fn</span> <span class="nf">keyboard_interrupt_handler</span><span class="p">(</span>
    <span class="n">_stack_frame</span><span class="p">:</span> <span class="n">InterruptStackFrame</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nn">pc_keyboard</span><span class="p">::{</span><span class="n">layouts</span><span class="p">,</span> <span class="n">DecodedKey</span><span class="p">,</span> <span class="n">HandleControl</span><span class="p">,</span> <span class="n">Keyboard</span><span class="p">,</span> <span class="n">ScancodeSet1</span><span class="p">};</span>
    <span class="k">use</span> <span class="nn">spin</span><span class="p">::</span><span class="n">Mutex</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">x86_64</span><span class="p">::</span><span class="nn">instructions</span><span class="p">::</span><span class="nn">port</span><span class="p">::</span><span class="n">Port</span><span class="p">;</span>

    <span class="nd">lazy_static!</span> <span class="p">{</span>
        <span class="k">static</span> <span class="k">ref</span> <span class="n">KEYBOARD</span><span class="p">:</span> <span class="n">Mutex</span><span class="o">&lt;</span><span class="n">Keyboard</span><span class="o">&lt;</span><span class="nn">layouts</span><span class="p">::</span><span class="n">Us104Key</span><span class="p">,</span> <span class="n">ScancodeSet1</span><span class="o">&gt;&gt;</span> <span class="o">=</span>
            <span class="nn">Mutex</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Keyboard</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">layouts</span><span class="p">::</span><span class="n">Us104Key</span><span class="p">,</span> <span class="n">ScancodeSet1</span><span class="p">,</span>
                <span class="nn">HandleControl</span><span class="p">::</span><span class="n">Ignore</span><span class="p">)</span>
            <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">keyboard</span> <span class="o">=</span> <span class="n">KEYBOARD</span><span class="nf">.lock</span><span class="p">();</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">port</span> <span class="o">=</span> <span class="nn">Port</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">0x60</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">scancode</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">port</span><span class="nf">.read</span><span class="p">()</span> <span class="p">};</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nf">Ok</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="n">key_event</span><span class="p">))</span> <span class="o">=</span> <span class="n">keyboard</span><span class="nf">.add_byte</span><span class="p">(</span><span class="n">scancode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">=</span> <span class="n">keyboard</span><span class="nf">.process_keyevent</span><span class="p">(</span><span class="n">key_event</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">match</span> <span class="n">key</span> <span class="p">{</span>
                <span class="nn">DecodedKey</span><span class="p">::</span><span class="nf">Unicode</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">print!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">character</span><span class="p">),</span>
                <span class="nn">DecodedKey</span><span class="p">::</span><span class="nf">RawKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">print!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="n">PICS</span><span class="nf">.lock</span><span class="p">()</span>
            <span class="nf">.notify_end_of_interrupt</span><span class="p">(</span><span class="nn">InterruptIndex</span><span class="p">::</span><span class="n">Keyboard</span><span class="nf">.as_u8</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><a href="/assets/img/osdev/2023-04-26-20-27.gif" class="popup img-link "><img data-src="/assets/img/osdev/2023-04-26-20-27.gif" alt="" class="lazyload" data-proofer-ignore></a> <em>Writing Input!</em></p><p><br /></p><hr /><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://os.phil-opp.com/cpu-exceptions/">CPU Exceptions</a><li><a href="https://en.wikipedia.org/wiki/Interrupt_descriptor_table">Interrupt Descriptor Table</a><li><a href="https://wiki.osdev.org/Exceptions">OSDev Wiki Exceptions</a><li><a href="https://wikidev.in/wiki/assembly/8051/CPL">CPL Instruction</a><li><a href="https://en.wikipedia.org/wiki/Global_Descriptor_Table">Global Descriptor Table</a><li><a href="https://os.phil-opp.com/double-fault-exceptions/">Double Faults</a><li><a href="https://os.phil-opp.com/hardware-interrupts/">Hardware Interrupts</a><li><a href="https://en.wikipedia.org/wiki/Deadlock">Deadlock</a></ul><p><br /></p><hr /><h2 id="footnotes"><span class="mr-2">Footnotes</span><a href="#footnotes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="footnotes" role="doc-endnotes"><ol><li id="fn:footnote" role="doc-endnote"><p>is a data structure used by the x86 architecture to implement an <em>interrupt vector table</em>. which links a list of interrupt handlers with a list of interrupt requests. <a href="#fnref:footnote" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:fn-nth-2" role="doc-endnote"><p>the CPL instruction complements the value of the specified destination operand and stores the result back in the destination operand. Bits that previously contained a 1 will be changed to a 0 and bits that previously contained a 0 will be changed to a 1. <a href="#fnref:fn-nth-2" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:fn-nth-3" role="doc-endnote"><p>is a data structure used by Intel x86-family processors to define the characteristics of the various memory areas used during program execution, including the base address, the size, and access privileges like executability and writability. <a href="#fnref:fn-nth-3" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/lowlevel/'>LowLevel</a>, <a href='/categories/osdev/'>OSDev</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/lowlevel/" class="post-tag no-text-decoration" >lowlevel</a> <a href="/tags/osdev/" class="post-tag no-text-decoration" >osdev</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=OSDev%20%7C%20Chapter%203%20%7C%20Interrupts%20-%20Zeropio's%20Dojo&url=https%3A%2F%2Fzeropio.ninja%2F%2Flowlevel%2Fosdev%2Fchapter-3" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=OSDev%20%7C%20Chapter%203%20%7C%20Interrupts%20-%20Zeropio's%20Dojo&u=https%3A%2F%2Fzeropio.ninja%2F%2Flowlevel%2Fosdev%2Fchapter-3" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fzeropio.ninja%2F%2Flowlevel%2Fosdev%2Fchapter-3&text=OSDev%20%7C%20Chapter%203%20%7C%20Interrupts%20-%20Zeropio's%20Dojo" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/index">Index</a><li><a href="/sensei/shellcode-blacksmith">The Shellcode Blacksmith | Sensei</a><li><a href="/lowlevel/osdev/chapter-0">OSDev | Chapter 0 | Basic Kernel</a><li><a href="/malware/development/putty-1">MalDev | Putty</a><li><a href="/malware/development/dropper-explorer-1">MalDev | Dropper Explorer.exe</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/lowlevel/">lowlevel</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/osdev/">osdev</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/reversing/">reversing</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/lowlevel/osdev/chapter-0"><div class="card-body"> <em class="small" data-ts="1681336800" data-df="ll" > Apr 13, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OSDev | Chapter 0 | Basic Kernel</h3><div class="text-muted small"><p> Introduction This series, is a personal project focused on learning more about ASM, kernel development, computer basics, and Rust. This is not a professional blog, and I will be using resources fr...</p></div></div></a></div><div class="card"> <a href="/lowlevel/osdev/chapter-1"><div class="card-body"> <em class="small" data-ts="1681596000" data-df="ll" > Apr 16, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OSDev | Chapter 1 | Freestanding Rust</h3><div class="text-muted small"><p> Introduction The kernel will be written in Rust, which is why we need to do some preparations before starting to code. This will not be the beginning of development, but rather the setup phase. Th...</p></div></div></a></div><div class="card"> <a href="/lowlevel/osdev/chapter-2"><div class="card-body"> <em class="small" data-ts="1681682400" data-df="ll" > Apr 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OSDev | Chapter 2 | Rust Kernel</h3><div class="text-muted small"><p> Introduction Now that we have a freestanding Rust binary, the next step is to create the kernel. We will create a 64-bit kernel for the x86 architecture. As we saw in the first chapter, we will be...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/lowlevel/osdev/chapter-2" class="btn btn-outline-primary" prompt="Older"><p>OSDev | Chapter 2 | Rust Kernel</p></a> <a href="/lowlevel/osdev/chapter-4" class="btn btn-outline-primary" prompt="Newer"><p>OSDev | Chapter 4 | Memory Management</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/lowlevel/">lowlevel</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/osdev/">osdev</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/reversing/">reversing</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ZeropioWasTaken">zeropio</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
